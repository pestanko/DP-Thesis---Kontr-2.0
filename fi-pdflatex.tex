%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% I, the copyright holder of this work, release this work into the
%% public domain. This applies worldwide. In some countries this may
%% not be legally possible; if so: I grant anyone the right to use
%% this work for any purpose, without any conditions, unless such
%% conditions are required by law.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[
  digital, %% This option enables the default options for the
           %% digital version of a document. Replace with `printed`
           %% to enable the default options for the printed version
           %% of a document.
  twoside, %% This option enables double-sided typesetting. Use at
           %% least 120 g/m² paper to prevent show-through. Replace
           %% with `oneside` to use one-sided typesetting; use only
           %% if you don’t have access to a double-sided printer,
           %% or if one-sided typesetting is a formal requirement
           %% at your faculty.
  table,   %% This option causes the coloring of tables. Replace
           %% with `notable` to restore plain LaTeX tables.
  lof,     %% This option prints the List of Figures. Replace with
           %% `nolof` to hide the List of Figures.
  lot,     %% This option prints the List of Tables. Replace with
           %% `nolot` to hide the List of Tables.
  %% More options are listed in the user guide at
  %% <http://mirrors.ctan.org/macros/latex/contrib/fithesis/guide/mu/fi.pdf>.
]{fithesis3}
%% The following section sets up the locales used in the thesis.
\usepackage[resetfonts]{cmap} %% We need to load the T2A font encoding
\usepackage[T1,T2A]{fontenc}  %% to use the Cyrillic fonts with Russian texts.
\usepackage{hyperref}
\usepackage[
  main=slovak, %% By using `czech` or `slovak` as the main locale
                %% instead of `english`, you can typeset the thesis
                %% in either Czech or Slovak, respectively.
  english, german, russian, czech, slovak %% The additional keys allow
]{babel}        %% foreign texts to be typeset as follows:
%%
%%   \begin{otherlanguage}{german}  ... \end{otherlanguage}
%%   \begin{otherlanguage}{russian} ... \end{otherlanguage}
%%   \begin{otherlanguage}{czech}   ... \end{otherlanguage}
%%   \begin{otherlanguage}{slovak}  ... \end{otherlanguage}
%%
%% For non-Latin scripts, it may be necessary to load additional
%% fonts:
\usepackage{paratype}
\def\textrussian#1{{\usefont{T2A}{PTSerif-TLF}{m}{rm}#1}}
%%
%% The following section sets up the metadata of the thesis.
\thesissetup{
    date          = \the\year/\the\month/\the\day,
    university    = mu,
    faculty       = fi,
    type          = mgr,
    author        = Bc. Peter Stanko,
    gender        = m,
    advisor       = RNDr Nikola Beneš PhD,
    title         = {Kontr 2: Systém na automatizované spracovanie domácich úloh},
    keywords      = {keyword1, keyword2, ...},
    TeXkeywords   = {keyword1, keyword2, \ldots},
    abstract      = {This is the abstract of my thesis, which can

                     span multiple paragraphs.},
    thanks        = {Chcel by som podakovat sam sebe.},
    bib           = sources.bib,
}
\usepackage{makeidx}      %% The `makeidx` package contains
\makeindex                %% helper commands for index typesetting.
%% These additional packages are used within the document:
\usepackage{paralist} %% Compact list environments
\usepackage{amsmath}  %% Mathematics
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{url}      %% Hyperlinks
\usepackage{markdown} %% Lightweight markup
\usepackage{listings} %% Source code highlighting
\usepackage{titlesec}
\lstset{
  basicstyle      = \ttfamily,%
  identifierstyle = \color{black},%
  keywordstyle    = \color{blue},%
  keywordstyle    = {[2]\color{cyan}},%
  keywordstyle    = {[3]\color{olive}},%
  stringstyle     = \color{teal},%
  commentstyle    = \itshape\color{magenta}}
\usepackage{floatrow} %% Putting captions above tables
\floatsetup[table]{capposition=top}

\newcommand{\ssubsection}[1]{%
  \subsubsection[#1]{\raggedright\normalfont\itshape #1}}

\begin{document}
\chapter*{Úvod}
\addcontentsline{toc}{chapter}{Úvod}


%kapacitne limitované, užívateľsky neprívetivé a obsahuje  
% je poukazované na nevyhovujúci stav 
Už niekoľko rokov je na poradách predmetov \textit{PB071} a \textit{PB161} diskutovanou témou nevyhovujúci stav automatizácie opravy domácich úloh. V súčasnosti používané riešenie je nedostatočné, kapacitne limitované a užívateľsky neprívetivé, čo bolo impulzom pre návrh a implementáciu jeho náhrady, ktorú predstavuje táto práca. %Nový nástroj spĺňa požiadavky spomínaných predmetov a je aj ľahko rozšíriteľný a použiteľný.

Počas analýzy požiadaviek a návrhu systému sa dospelo k~záveru, že nástroj je z dôvodu jeho rozsiahlosti vhodné rozdeliť na viacero samostatných komponentov. Vďaka definovaným rozhraniam a využitiu technológii známych na Fakulte informatiky Masarykovej univerzity (ďalej FI MU) je možné časti systému spracovávať samostatne ako diplomové alebo bakalárske práce.

% TODO: citovat Kontr, M. Miklosovu pracu
Projekt \textit{Kontr 2} má za cieľ stať sa úspešným následníkom nástroja \textit{Kontr} z roku 2011, ktorý v predmetoch Úvod do nízkoúrovňového programování (kód PB071) a Programování v jazyce C++ (kód PB161) automatizuje prijímanie, spracovanie a hodnotenie domácich úloh. Nástroj vyučujúcim poskytuje aj webové rozhranie \textit{kontr-logs}, schopné zobrazovať jednotlivé odovzdania. Kontr má mnohé nedostatky, kvôli ktorým ho je vhodné nahradiť. Medzi najvýznamnejšie patria škálovateľnosť, využívanie zastaralých technológií, neprehľadná kódová základňa a nezanedbateľné bezpečnostné chyby.

Nový projekt vzniká nezávisle na nástroji Kontr a snaží sa vyhnúť jeho chybám. Využitím moderných technológii a štrukturovaným návrhom umožňuje zapojenie širšieho okruhu vývojárov z radov vyučujúcich i študentov. Projekt je vydaný ako projekt s otvoreným zdrojovým kódom a definovanými procesmi ako do neho prispievať.

%Samotné hodnotenie odovzdaní sa skladá z dvoch fáz. Prvou je automatizovaná oprava a udelenie bodov za funkcionalitu, druhou je prezretie a ohodnotenie kvality kódu človekom vo forme komentárov ku kódu. - toto sem nepatri
V tejto práci je popísaná analýza požiadaviek na systém automatizovanej opravy domácich úloh Kontr 2, navrhnutá štruktúra systému a implementovaná jeho výkonná časť, ktorá poskytuje syntax a behové prostredie pre vykonávanie prispôsobiteľných testov. Dôležitou časťou práce bola identifikácia komponentov systému, určenie rozhraní a komunikácie medzi komponentmi, vymedzenie hraníc systému a jeho komunikácie ako celku s externými entitami (Databáza, Dodávateľ identít, Informačný systém Masarykovej univerzity (ďalej IS MU)).

Vytvorený systém umožňuje automatizované spracovanie študentských riešení programovacích domácich úloh v širokom spektre predmetov s možnosťou prispôsobenia ich špecifickým požiadavkám. Systém poskytuje rozhranie na prijímanie študentských odovzdaní, umožňuje ich spracovanie automatizovanými nástrojmi kontroly kvality a v štrukturovanej forme sprístupňuje výsledky vyučujúcim aj študentom.

Prácu sa skladá zo štyroch logických častí. Prvá časť práce sa venuje analýze požiadaviek a popisu technológii a konceptov použitých v práci. Zavádza pojmy z problémovej domény a prestavuje problematiku automatizovaného spracovania úloh. Druhá časť práce sa zaoberá návrhom systému, popisom rozhraní a komunikácie jednotlivých komponent. Tretia časť obsahuje popis implementácie častí systému, použitých technológii a procesov definovaných na uľahčenie spolupráce viacerých vývojárov. Štvrtá časť sa venuje nasadeniu systému, testovacej prevádzke a spôsobom dodania jednotlivých závislostí a častí systému. 
% TODO skontrolovať na konci
% procesy na spolupracu vyvojarov sem imo nepatria, ked tak do prilohy alebo len ako contribution guide v projekte

\chapter{Automatizovaná oprava domácich úloh}

Na FI MU je vyučovaných mnoho programovacích predmetov, v ktorých sú zadávané programátorské úlohy. Ich riešením je kód, ktorý študent podľa zadania vytvára v predpísanom programovacom jazyku. Riešenia úloh sú hodnotené na základe ich funkčnosti (miery naplnenia zadania), programátorského štýlu, prípadne ďalších kritérií špecifických pre predmet. 

Proces hodnotenia prebieha spravidla v troch krokoch:
\begin{enumerate}
    \item Študent svoje vypracované riešenie sprístupní hodnotiteľovi (človeku alebo systému). Najviac využívanými metódami odovzdania na FI MU sú nahranie súborov do \textit{Odevzdávárny} IS MU alebo sprístupnenie kódu pomocou systému na správu verzií, napr. \textit{Git} alebo \textit{SVN}. 
    \item V definovanom termíne opravujúci získa študentovo odovzdanie, ohodnotí mieru naplnenia zadania, programátorského štýlu, efektívnosti, prípadne iných kritérií špecifických pre predmet. 
    \item Hodnotenie je prevedené na body či slovné zhrnutie a uložené v IS MU, typicky pomocou zápisu do \textit{Poznámkových blokov} IS MU.
\end{enumerate}

Všetky tri kroky tohoto procesu je možné do určitej miery automatizovať a odbremeniť tak vyučujúcich. Pre automatizáciu je možné využiť jednoduché porovnávanie výstupu, rámce a knižnice pre jednotkové testy (napr. \textit{JUnit}, \textit{Catch}), nástroje na kontrolu formátovania (\textit{clang-format}, \textit{pylint}), programátorského štýlu (\textit{clang- tidy a clang-format}, \textit{Rubocop}) alebo zložitosti kódu (\textit{Rubocop}, \textit{checkstyle}). Ich hlavnými výhodami sú rýchlosť a jednotnosť (v hodnotení aj vo výstupe), ktorá garantuje rovnaké podmienky pre všetkých študentov. Študentom je tak možné rýchlejšie poskytnúť spätnú väzbu na ich riešenia, prípadne ich nasmerovať na príčinu zlyhania. Rovnako sa znižuje aj miera nejednotnosti hodnotenia, často prítomná ak je hlavným hodnotiteľom človek.

Minimalizácia či odstránenie ľudského faktoru z procesu opravy úloh prináša časovú úsporu študentom i vyučujúcim, zjednocuje podmienky hodnotenia úloh, prináša jasný, kvantifikovateľný výstup a zmenšuje priestor pre chyby. Automatická kontrola odovzdaní však človeka nemá plne nahradiť, zapojenie opravujúceho je v procese výuky jednou z nevyhnutných podmienok. Podobne ako zákony nie je možné vykladať na súde strojovo, ale je potrebný sudca, tak aj pri opravovaní úloh je potrebný ľudský zásah na rozsiahlu a personalizovanú spätnú väzbu. Cieľom automatizácie je človeku prácu zjednodušiť a študentom poskytnúť aspoň nejakú spätnú väzbu rýchlejšie.

Z týchto dôvodov som presvedčený, že zavedenie nového, ideálne centrálne spravovaného nástroja pre automatizáciu procesu odovzdávania úloh môže byť veľkým prínosom pre mnoho programovacích predmetov vyučovaných na FI MU. Počet študentov prijímaných na FI MU stále stúpa a zefektívnenie práce vyučujúcich je preto vhodným spôsobom, ako udržať kvalitu štúdia na dobrej úrovni.

Aby bol systém na automatickú opravu domácich úloh použiteľný, musí byť pri jeho návrhu a implementácií kladený dôraz na niekoľko významných vlastností:

\begin{itemize}
    \item \textit{Bezpečnosť} - Žiaden používateľ by nemal byť schopný čítať alebo meniť informácie ku ktorým nemá mať prístup. Zmeny v systéme musia byť zaznamenávané, aktéri identifikovateľní. Činnosť bežných používateľov nesmie ohroziť stabilitu a dostupnosť systému.
    \item \textit{Škálovateľnosť} - V prípade potreby je možné zvýšiť priepustnosť systému pridaním ďalších zdrojov.
    \item \textit{Robustnosť} - V prípade výpadku je možné systém obnoviť, predovšetkým je potrebné zaručiť integritu používateľských dát.  
    \item \textit{Prenositeľnosť} - Systém alebo jeho časti je možné nasadiť na rôznych platformách alebo verziách operačného systému.
    \item \textit{Ľahkú rozšíriteľnosť} - Do systému je možné bez veľkých zásahov pridať novú funkcionalitu alebo pozmeniť už existujúcu.
    \item \textit{Integrácia} - Systém je možné napojiť na služby poskytované FI~MU a~IS~MU.
\end{itemize}

Systém s výraznými nedostatkami v ktorejkoľvek z týchto kategórií je v praxi nepoužiteľný. Preto boli tieto kritériá základom môjho ďalšieho rozhodovania a hlavným dôvodom zamietnutia už existujúcich nástrojov pre potreby FI MU. Napriek tomu je podstatné uviesť existujúce riešenia a predstaviť dôvody implementácie vlastného projektu.

\section{Existujúce automatizačné nástroje}

%V rôznych kontextoch je automatizácia kontroly 
% Na automatizované spracovanie a hodnotenie rôznych artefaktov, napríklad zdrojových kódov, existuje niekoľko nástrojov. Medzi najpokročilejšie patria X, Y, Z, ktoré pre samostatný projekt Kontr 2 predstavujú nezanedbateľnú konkurenciu. Prístupy týchto nástrojov sú rôzne, od projektu s otvoreným zdrojovým kódom \textit{Submitty}\footnote{https://submitty.org/}, ktorý je možné nasadiť a používať na vlastnej infraštruktúre po komerčné \emph{cloudové riešenia} ako \textit{Vocareum}\footnote{https://www.vocareum.com/} alebo \textit{GradeScope}\footnote{https://www.gradescope.com/}. TODO: rozsirit, chce to hlbsiu analyzu. Kludne na kazdy nastroj subsection, ako CI/CD 

% cca 1 stranu, vyjde dobre aj formatovanie (1 odstavec ku kazdemu)
Existujú rôzne už existujúce nástroje na automatizovanú opravu domácich úloh, od tých s otvoreným zdrojovým kódom napríklad  \textit{Submitty}\footnote{https://submitty.org/}, ktoré je možné nasadiť a používať na vlastnej infraštruktúre, až po celé komerčné \emph{cloudové riešenia} \textit{Vocareum}\footnote{https://www.vocareum.com/} alebo \textit{GradeScope}\footnote{https://www.gradescope.com/}, ktoré sú platené.

Plateným nástrojom som sa chcel od začiatku vyhnúť pretože s nimi prichádzajú problémy ako obtiažné prispôsobenie, komplikované licenčné podmienky a nedostatočná transparentnosť. GDPR.

Riešenie s otvoreným zdrojovým kódom nedosahovalo dostatočnú mieru rozšíriteľnosti pre špecifické požiadavky niektorých predmetov vyučovaných na fakulte.
Existujúce nástroje zaostávali v ohľadoch flexibility, či už možnosti rozšírenia, platformovou závislosťou, nedostatočnou úrovňou oprávnení alebo obsahovali nepotrebnú funkcionalitu.

Po preštudovaní dostupných nástrojov, zvážení ich výhod, ale aj nevýhod som dospel k záveru, že vlastná implementácia je najlepšou cestou, nad ktorou bude mať fakulta a jednotlivé predmety kontrolu. Bude možné ju upraviť a prispôsobiť podľa požiadaviek. Ďalšou výhodou bude jednoduchá integrácia so službami využívanými a poskytovanými na FI MU.

\subsection{CI/CD Nástroje}

Priebežná integrácia (Continous Integration, CI) je v súčasnosti jedným z hlavných princípov využívaných pri vývoji softvéru. Ide o spúšťanie automatizovaných testov nad každou novou verziou kódu systému, čo umožňuje väčšiu mieru kontroly jeho spoľahlivosti a rýchle odhaľovanie chýb. Dôvera vo fungovanie systému po každej zmene je základom implementácie priebežného doručovania (Continuous Delivery, CD). Rýchle nasadenie otestovaných zmien umožňuje inkrementálny vývoj systému a odstraňuje možnosť zanášania chýb či nekonzistencií spôsobených ľudským faktorom. Medzi najširšie používané nástroje CI/CD patria \textit{Jenkins}, \textit{Travis} a \textit{GitLab-CI}. 

Spomenuté nástroje by bolo možné využiť pri automatickej oprave domácich úloh, pretože ich princíp sa do určitej miery prekrýva s myšlienkou kontroly domácich úloh. Hlavnou úlohou CI/CD nástrojov je spúšťanie tzv. \emph{jobov} na základe nejakej notifikácie, prijímanej väčšinou vo forme \emph{webhooku}. Job je súbor akcií, ktoré sa majú vykonať pri prijatí definovanej notifikácie. Typicky ide o skript v nejakom programovacom jazyku, ktorý umožňuje definíciu požadovaných akcií. Využívané sú predovšetkým na spúšťanie automatizovaných testov v systémoch na správu \emph{git repozitárov} ako napríklad \emph{GitLab} alebo \emph{GitHub}, spolu s prípravou či nasadením do určitého behového prostredia.  

Hlavnou výhodou CI/CD nástrojov je, že väčšina ľudí sa s nimi v programátorskej praxi stretne a nebudú pre nich úplnou novinkou. Korektná konfigurácia týchto nástrojov je ale pre účely automatizovanej opravy domácich úloh pomerne komplikovaná. V nástrojoch totiž nie sú dostatočne oddelené úrovne oprávnení a nie je jednoduché ich nastaviť tak, aby sa neoprávnení používatelia nedostali k citlivým dátam. Druhým problémom je komplikovaný popis zložitejších testovacích scenárov, ktorý by pre zadávajúceho domácej úlohy znamenal netriviálnu záťaž. Nástroje tiež nie je možné jednoducho prispôsobiť a upraviť aby splňovali jednotlivé požiadavky predmetov, ktoré sa môžu meniť každý semester.  

\subsection{Nástroj Kontr}

Na FI MU je v súčastnosti v predmetoch PB017 a PB161 používaný nástroj Kontr, ktorý bol vytvorený v roku 2011 RNDr. Šimonom Tóthom. Nástroj vznikol v pomerne krátkom čase ako sada skriptov v jazyku \emph{Perl} verzie 5 a od svojho vzniku prešiel mnohými zmenami. Práve krátky čas, v ktorom bol nástroj implementovaný má za následok niekoľko zásadných chýb v návrhu, vďaka ktorým obsahuje mnohé nedostatky v rozšíriteľnosti, prenositeľnosti a bezpečnosti. O správu nástroja a jeho úpravy sa v súčasnosti stará Mgr. Roman Lacko. 

Aktuálna verzia nástroja Kontr využíva sadu skriptov v programovacom jazyku Perl pomocou ktorých študent pri odovzdaní spustením skriptu \emph{odevzdavam} vytvorí nový súbor v priečinku s informáciou, pre ktorý predmet a pre ktorú úlohu bolo odovzdanie vytvorené. Následne sa v päťminútových intervaloch spúšťa \textit{Cron job}[link], ktorý prejde adresár a postupne spustí vykonávanie jednotlivých odovzdaní. Odovzdanie je spustené s právami užívateľa \emph{kontr} definovaného vo fakultnej databáze používateľov. Súčasťou spracovania je stiahnutie študentovho vypracovania z repozitáru na fakultnom GitLab-e. Kontr si obsah repozitára uchováva dlhodobo (až do jeho manuálneho zmazania) a pre aktualizáciu vykonáva príkaz \texttt{git pull}. Testovanie je vykonávané pomocou vlastného testovacieho rámca implementovaného v jazyku Perl, ktorý je súčasťou samotného nástroja. Testovacie scenáre sú dodávané v separátnom repozitári. Kontr po dokončení testovacieho procesu odošle email s výsledkami študentovi aj jeho opravujúcemu pre danú domácu úlohu. Jeho aktuálna verzia tiež dokáže komunikovať s rozhraním Poznámkových blokov IS MU, kam automaticky zapisuje výsledky testov aj s bodovým hodnotením.

Výsledky automatizovaného testovania je možné prezerať vo webovom rozhraní určenom pre opravujúcich domácich úloh. Je v ňom možné zobraziť výsledky jednotlivých testov, vygenerované výstupy behu testov a samotné odovzdania študentov. Nástroj tiež dokáže porovnávať zdrojové kódy jednotlivých odovzdaní a dovoľuje znova otestovať už existujúce odovzdanie. 

Napriek svojej užitočnosti je Kontr nevhodný na ďalšie používanie predovšetkým kvôli nasledujúcim vadám:
\begin{itemize}
    \item monolitická architektúra: celý systém je jeden celok a chyba jednej z jeho častí môže spôsobiť zlyhanie celého nástroja. Silná previazanosť súčastí nástroja zhoršuje jeho rozšíriteľnosť.
    \item jazyk Perl: na FI MU nie je vyučovaný. Nástroj tiež využíva zastaralé knižnice a už nepodporovanú verziu jazyka. 
    \item neprehľadná kódová základňa: v snahe minimálne zasahovať do jadra nástroja rozšírenie Kontru neprebieha zmenou v jeho kódovej základni, ale sadou podporných skriptov. Z dlhodobého hľadiska ide spolu s ostatnými nedostatkami o neudržateľné riešenie.
    \item bezpečnostné vady: Odovzdaný kód sa môže dostať aj k informáciám, ku ktorým by nemal mať prístup, dokonca by mohol zmazať alebo poškodiť celý domovský adresár užívateľa \textit{kontr}.
    \item neprenositeľnosť: Kontr je pevne zviazaný s fakultnou infraštruktúrou natoľko, že ho nie je možné spustiť mimo stroja \textit{Aisa}. Dôsledky tohoto obmedzenia sú predovšetkým nízka škálovateľnosť z dlhodobého (nedostatočné diskové kvóty na skladovanie odovzdaní) i krátkodobého hľadiska (vysoké vyťaženie stroja pred koncom odovzdávaní) a platformová závislosť.
    \item nedostatočné oddelenie oprávnení: Aktuálna architektúra predpokladá striktné oddelenie role študent a učiteľ pre všetky predmety. Preto ak je užívateľ učiteľom, má učiteľské práva pre \emph{všetky} predmety.
\end{itemize}

\chapter{Analýza požiadaviek na Kontr 2}

Pri vývoji nového softvéru je analýza požiadaviek základom, z ktorého vyplýva užitočný návrh a implementácia zodpovedajúca zámeru projektu. Keďže chyby v požiadavkách na systém sa typicky prejavujú až v jeho prevádzke, je kritické tejto fáze venovať najviac pozornosti. 

Funkčné i nefunkčné požiadavky na nový systém vyplývajú predovšetkým z dvoch zdrojov: odhalené nedostatky nástroja Kontr a od vyučujúcich rôznych programovacích predmetov na FI MU, ktorí by mali záujem Kontr 2 v budúcnosti využívať. Oba zdroje sú rovnako podstatné, aby bol nový nástroj využiteľný v praxi. Okrem toho je nutné v dostatočnej miere dbať na kritériá stanovené v [odkaz vyššie]. Pre potreby tejto analýzy boli oslovení vyučujúci programovacích predmetov na FI MU, ktorí by nový systém mohli v budúcnosti využívať. 

Najviac detailne projekt zohľadňuje požiadavky predmetov \emph{C} a \emph{C++}, ktoré automatizáciu opravy úloh využívajú aj dnes a sú primárnymi kandidátmi na budúcich používateľov Kontru 2. Všeobecné požiadavky predmetov vyučujúcich \emph{Javu}, \emph{Python}, \emph{Ruby} alebo programovanie v jazyku C\# boli spracované menej detailne a systém bude pred použitím v týchto predmetoch nutné mierne pozmeniť.
%Napríklad možnosť vykonávania testov na platforme Windows nie je v odovzdanej verzii systému podporovaná a vyžadovala by komplexnejší výskum.

\section{Funkčné požiadavky}

Funkčné požiadavky definujú požadované správanie systému. Vychádzajú predovšetkým z funkcionality Kontru, ktorú bolo potrebné zachovať, a doplňujúcich požiadaviek zistených od vyučujúcich na FI MU. Ide o detailnejšie rozpracovanie myšlienky automatickej opravy domácich úloh na čiastkové procesy, ktoré umožňuje presnejšie premietnutie celkového výukového procesu FI MU do nového nástroja. Pre prehľadnosť požiadavky uvádzam v samostatných kategóriách napriek tomu, že kategórie sú navzájom prepojené.

\subsection{Hlavný prípad použitia}

Systém Kontr 2 je určený na automatizáciu procesu opravy domácich úloh. V kontexte výuky na FI MU pojem \textit{odovzdanie} odkazuje na jednu inštanciu riešenia zadania domácej úlohy. Typicky ide o funkčný kód, ktorý je základom pre hodnotenie študenta v danej úlohe. V programovacích predmetoch na FI MU je často podmienkou úspešného ukončenia predmetu vyriešenie celého súboru úloh, zadávaného počas semestra. Úlohy majú za cieľ overiť a precvičiť nadobudnuté schopnosti študentov v preberaných oblastiach. 

Hlavným prípadom užitia systému je poskytnúť nástroj pre automatizované spracovanie \emph{odovzdania}. Odovzdanie vytvára študent pre \emph{domácu úlohu (projekt)}, ktorá bola zadaná v študovanom \emph{predmete}. Nad odovzdaním je spustená definovaná sada testovacích scenárov, ktoré majú za cieľ otestovať funkcionalitu. Výsledky testovania sú následne zaznamenané a vyhodnotené. O dostupnosti výsledkov je notifikovaný \emph{študent} aj \emph{opravujúci} pridelený danému študentovi, väčšinou učiteľ.

Proces automatizovanej opravy študentských riešení v minimálnej podobe obsahuje v časovej následnosti tieto kroky:
\begin{enumerate}
    \item Študent sa prihlási do systému
    \item Študent si vyberie predmet a úlohu
    \item Študent vytvorí odovzdanie s dodatočnými parametrami potrebnými pre spracovanie odovzdania a jeho správnu kategorizáciu
    \item Systém odovzdanie uloží a pripraví prostredie pre jeho spracovanie
    \item Systém spustí automatizované spracovanie odovzdania - testovacie scenáre
    \item Systém vyhodnotí výsledky testov a výsledky trvalo uloží
    \item Systém notifikuje autora odovzdania a jeho opravujúceho o výsledkoch.
\end{enumerate}

Zjednodušený priebeh takejto opravy je spolu so zodpovedajúcimi nahradenými krokmi manuálnej opravy znázornený v diagrame X:
\ picture


\subsection{Automatické spracovanie odovzdania}

Pri spracovaní študentského riešenia úlohy je potrebné, aby systém dokázal prijímať odovzdania z rôznych zdrojov (predovšetkým zo systému \emph{git}), dokázal ich dlhodobo uložiť, spracovať ich a sprístupniť výsledky spracovania študentom aj vyučujúcim. Popis modelovaného procesu a zasadenie entity \textit{odovzdanie} do kontextu je detailne rozpracované v bakalárskej práci Bc. Barbory Kompišovej [link].

Spracovanie odovzdaní je potrebné časovo plánovať. Študent má mať možnosť svoje odovzdanie zrušiť v presne definovanom časovom intervale, pred tým, než sa začne spracovávať. Rovnako je potrebné zabrániť zneužívaniu nástroja príliš častým odovzdávaním -- študent má preto povolený len obmedzený počet odovzdaní za určitý časový interval, čím je možné do určitej miery zabrániť preťaženiu nástroja (\emph{rate limit})\footnote{\url{https://en.wikipedia.org/wiki/Rate_limiting}}.

Podobne ako existujúci nástroj Kontr je vhodné, aby Kontr 2 umožňoval prezeranie, hodnotenie a porovnávanie odovzdaní vyučujúcimi. Študenti si smú prezerať svoje vlastné odovzdania, spolu s prípadnými komentármi a hodnotením vyučujúceho. 

Pred študentmi je potrebné skryť časti výstupu testov, aby sa predišlo "implementáciám podľa testov" namiesto implementácií podľa zadania úlohy. Možnosť práce s odovzdaním priamo cez nástroj Kontr~2 (prezeranie zdrojových kódov odovzdaní, ich komentovanie) zrýchli prácu opravujúcich, pretože nebudú musieť získavať odovzdania a výsledky automatického spracovania manuálne. 

V budúcnosti je možné rozšíriť systém tak, aby sa hodnotenia zadané do Kontru 2 automaticky premietali aj do hodnotenia v Poznámkových blokoch IS MU. Pre zjednodušenie práce so systémom je tiež prínosné rozosielať študentom i vyučujúcim notifikácie o spustených spracovaniach odovzdaní a ich výsledkoch. 

\subsection{Užívatelia a logické členenie}

Pre použitie systému Kontr 2 v reálnej prevádzke je potrebné zabezpečiť správu používateľských účtov a prístupových práv, aby sa predišlo únikom informácií o úlohách a odovzdaniach. Z používateľského pohľadu tu má zásadnú úlohu autentizácia používateľov, ktorú je možné zabezpečiť integráciou s existujúcimi autentizačnými mechanizmami na FI~MU, získať prístup dostupným informáciám o užívateľoch a podrobnejšiu kontrolu používateľských oprávnení.

Autorizácia používateľov musí zodpovedať ich právam v modelovanom procese výuky. Predovšetkým je nutné oprávnenia spravovať na úrovni predmetov, nie celého systému, ako s nimi pracuje súčasný Kontr. Je totiž možné, že jeden užívateľ je počas jedného semestra vyučujúci jedného predmetu a študent iného, čo mu v každom predmete pripisuje inú množinu oprávnení. Vzhľadom na rozdielnu organizačnú štruktúru študovaných predmetov je vhodné umožniť jemnejšie oddelenie právomocí než len dve základné roly (študent/vyučujúci), čím je možné modelovať napríklad roly \emph{pomocník} či \emph{vlastník predmetu (prednášajúci)}, ktoré lepšie zodpovedajú realite.

Rôzne predmety môžu mať rôzne požiadavky na priradenie rolí alebo oprávnení pre jednotlivých užívateľov. Napríklad pre predmet C++ bolo potrebné umožniť prideľovanie vyučujúceho (opravujúceho) študentovi pre každú úlohu osobitne.

\subsection{Požiadavky na správu a komunikáciu}

Administrácia systému prebieha na dvoch úrovniach -- vyučujúcimi, ktorí sú zodpovední za určitý predmet, a systémovým administrátorom, ktorý prevádzkuje a monitoruje všetky komponenty systému. 

Vyučujúci predmetu má v rámci daného predmetu predovšetkým možnosť spravovať oprávnenia používateľov a jednotlivé úlohy. Principiálne ide len o konfiguráciu malej množiny funkcionality systému, špecifickej pre daný predmet. Pre pohodlnú prácu je však výhodné sprístupniť potrebné administratívne úkony v rozhraní systému, aby ich bolo možné vykonávať automatizovane.

Správa celého systému zahŕňa predovšetkým nasadenie a monitorovanie všetkých jeho súčastí. Je potrebné mať možnosť komponenty systému spravovať vzdialene pomocou administrátorského rozhrania, vyžadujúceho špeciálny typ používateľa a autentizáciu na úrovni každej samostatnej súčasti systému.

Bežným používateľom je vhodné pre jednoduché používanie funkcionalitu systému sprístupniť pomocou grafického rozhrania. Medzi jednotlivými komponentmi je potrebné umiestniť strojovo ľahko spracovateľné rozhrania. Rozhrania umožňujú nízku previazanosť komponentov, ich škálovateľnosť (napr. zvýšením počtu replík), využitie rôznych konkrétnych implementácií a prípadné nahradenie celej komponenty.

\section{Nefunkčné požiadavky}

Okrem funkcionality je pre systém potrebné špecifikovať aj požiadavky a obmedzenia na prevádzku systému, nazývané tiež nefunkčné požiadavky. Definujú podmienky prevádzky systému ako celku v niekoľkých oblastiach. Ich cieľom je zaručiť kvalitu prevádzky aj procesu vývoja výsledného produktu.

\subsection{Bezpečnosť}
Bezpečnosť systému je jednou zo základných požiadaviek a zasahuje do mnohých jeho častí.

Jedným aspektom je kontrola prístupu používateľov k údajom v systéme, ktorú je potrebné zabezpečiť pomocou autentizačných a autorizačných mechanizmov, detailnejšie popísaných v časti X. % TODO

Druhou časťou bezpečnosti systému je nutnosť ochrany proti externým útočníkom. Predovšetkým je nutné zabezpečiť, aby všetka komunikácia vonkajšieho sveta so systémom prebiehala šifrovane, sanitizovať vstupy a znížiť dopad útokov typu DOS[cite]. 

Tretím bodom je zabezpečenie izolovaného prostredia spúšťania odovzdaní študentov a odstrániť tak nebezpečenstvo ovplyvňovania systému, interferencií medzi odovzdaniami, úniku a poškodeniu či neoprávnenej úprave dát (napr. testov k danej úlohe).

Pre správu a audit prevádzky systému je vhodným základným mechanizmom zaznamenávanie (\emph{logovanie}) akcií používateľov. Podľa týchto záznamov by malo byť možné identifikovať aktérov, priradiť ich k vykonávaným akciám a analyzovať tak potenciálne a skutočné hrozby pre systém. V produkčnej prevádzke systému je takéto záznamy možné využiť aj pre monitorovanie systému v reálnom čase a rýchlu odozvu správcov v prípade problémov. Nasadenie vhodného monitorovacieho riešenia predstavuje zaujímavé a potenciálne rozsiahle rozšírenie systému, ktoré bohužiaľ v rámci tejto práce nebolo možné realizovať.

\subsection{Trvácnosť}
Systém Kontr 2 potrebuje pre dlhodobú prevádzku uchovávať svoj stav v nejakom perzistentnom úložisku. V týchto dátach, reprezentujúcich entity v systéme, je potrebné efektívne vyhľadávať a manipulovať s nimi pri bežnej prevádzke systému. Ide o štrukturované, hierarchicky organizované dáta, reprezentujúce odovzdania a s nimi súvisiace organizačné zložky malej veľkosti, ktoré je vhodné ukladať v relačnej databáze. 

Pre ukladanie potenciálne veľkých súborov odovzdaní a testov a ich a adresárovej štruktúry je potrebné použiť vhodný prístup, iný než pre správu "prevádzkových" dát. Jednotlivé odovzdania je potrebné archivovať v logickej štruktúre, pre možnosť vyhľadávania, aktualizácie a zobrazovania previazanej s používateľmi. Jednou z možných optimalizácií potrebného diskového priestoru je zdieľanie testovacích súborov úlohy medzi odovzdaniami. Pri dlhšej prevádzke systému je prínosné nepoužívané dáta komprimovať, prípadne mazať. Ďalším vhodným opatrením je klásť obmedzenia na ukladané dáta zo študentských odovzdaní v systéme, čím sa dá predchádzať zahlteniu diskového priestoru súbormi nepotrebnými pre spracovanie odovzdaní.

\subsection{Škálovateľnosť a prenositeľnosť}

V systéme je potrebné identifikovať úzke body a minimalizovať ich dopady na výkon. Systém by mal byť rozdelený na viaceré navzájom nezávislé časti, ktoré je možné v prípade potreby presunúť alebo zvýšiť počet ich replík -- procesov či strojov, na ktorých systém beží. 

Súčasti systému by na infraštruktúru FI MU mali byť naviazané čo najmenej, aby ich bolo možné bez veľkých ťažkostí nasadiť na rôznych strojoch a v rôznych prostrediach (aj keď len s obmedzenou funkcionalitou -- napríklad bez autentizácie pomocou služieb FI~MU). Obmedzením sú požiadavky využívaných systémov FI~MU napr. na sieťovú dostupnosť, ktorým sa Kontr 2 musí prispôsobiť.

\subsection{Ľahká rozšíriteľnosť}

Cieľom projektu je vytvoriť infraštruktúru pre automatizovanú opravu domácich úloh a vytvoriť prototyp potrebných modulov na prevádzku v malej množine predmetov vyučovaných na FI MU. Dekompozícia systému a návrh komponentov však musí umožňovať jednoduché rozšírenie a úpravy pre potreby iných predmetov, aby systém mohol byť rozšírený do širšieho okruhu používateľov a potenciálnych prispievateľov. Práve širší okruh používateľov je jednou z podmienok úspechu open-source projektu Kontr 2, ktorý sa pre svoj ďalší vývoj bude spoliehať práve na prispievateľov z radov svojich používateľov.

\subsection{Integrácia s externými službami}
Využitie existujúcich služieb odstraňuje nutnosť synchronizácie dát medzi rôznymi systémami a umožňuje rýchlejší vývoj Kontru 2. Systém by sa mal dať integrovať s inými službami využívanými na FI MU pre uľahčenie práce s novým systémom. Možné prvotné spojenia sú s fakultnou inštanciou GitLabu ako s poskytovateľom identít, IS MU pre synchronizáciu predmetov a študentov v nich alebo prácu s Poznámkovými blokmi, fakultným LDAP-om pre získavanie dodatočných informácii o užívateľoch či s fakultným SMTP serverom pre odosielanie emailových notifikácií. Pre systém v prvej verzii nie je plánované využitie iných než fakultných služieb, no principiálne je v ďalšom vývoji možné.

\chapter{Návrh}
Na základe analýzy požiadaviek na systém bolo možné vytvoriť návrh, ktorý detailne rozpracováva požadovanú funkcionalitu do štrukturálnych celkov -- komponentov, obsahujúcich kľúčové entity a procesy a definuje rozhrania a komunikáciu medzi nimi. Kapitola predstavuje jednotlivé celky a ich časti a definuje ich zodpovednosti. Zároveň približuje riešenie nefunkčných požiadaviek pre každú súčasť systému zvlášť. Záverom návrhu je prehľad prepojenia častí systému v hlavnom prípade použitia. 

%Pojem \emph{Systém} popisuje Kontr 2 ako celok so všetkými komponentmi a väzbami medzi nimi. Hlavný prípad použitia systému je popísaný v kapitole analýza. \emph{Komponenta systému} je samostatná časť systému, z ktorej systém pozostáva. V systéme je možné taktiež identifikovať jednotlivé \emph{entity} a vzťahy medzi nimi. \emph{Entita} \footnote{https://www.sqa.org.uk/e-learning/MDBS01CD/page_06.htm} je akýkoľvek objekt alebo reprezentácia, ktorý chceme modelovať a ukladať o ňom informácie.

\section{Entity a aktéri v systéme Kontr 2}

Z hlavného prípadu použitia vyplývajú základné entity systému Kontr 2: \emph{používateľ}, \emph{kurz}, \emph{projekt} a \emph{odovzdanie}. Používatelia so systémom interagujú v rámci svojich \emph{rolí}, definovaných na úrovni predmetov. Pre možnosť ľahkého rozšírenia a dostatočného prispôsobenia role a právomoci s nimi spojené nie sú pevne dané a je možné pre každý kurz vytvoriť vlastnú sadu rolí a nastaviť pre ne rôzne úrovne \emph{oprávnení}.

Potreba určenia opravujúceho pre každú úlohu je splnená pomocou \emph{skupín užívateľov} v predmetoch, podobných seminárnym skupinám. Pomocou nich je možné opravujúcim (cvičiacim) pre vybraný projekt prideliť skupinu študentov. Skupiny umožňujú predovšetkým jemnejšie riadenie prístupových oprávnení k odovzdaniam, takže napr. opravujúcemu určitej skupiny je možné umožniť prístup iba k odovzdaniam študentov v tejto skupine. Rovnako je na skupinu možné naviazať notifikácie.


\section{Hlavné komponenty}

V návrhu systému figurujú tri hlavné komponenty: Portál, KTDK (Kontr Test Development Kit) a Pracovník (Worker), z ktorých každý spracováva samostatnú časť funkcionality. Komponenty sú navzájom nezávislé a poskytujú štrukturované rozhranie na komunikáciu a ovládanie. Každý z hlavných komponentov je podrobnejšie priblížený vo vlastnej sekcii spoločne so svojimi subsystémami.

Hlavné komponenty majú vlastnú vnútornú štruktúru a využívajú rôzne moduly a knižnice, ktoré bolo potrebné implementovať a integrovať. Ide o tzv. \emph{pomocné komponenty}, ktoré logicky združujú časti funkcionality svojich rodičovských komponentov. Medzi pomocné komponenty patrí napríklad \textit{Úložisko} (Storage), ktoré je využívané portálom na zabezpečenie trvácnosti súborov odovzdaní. Jednotlivé pomocné komponenty sú predstavené spolu s ich hlavnými komponentmi.

\textit{Portál} je hlavným komponentom, ktorý má za úlohu logicky modelovať organizačnú štruktúru entít a vzťahy medzi nimi, vystaviť hlavné rozhranie pre prácu so systémom a orchestrovať ostatné časti systému. 

\textit{KTDK (Kontr Test Development Kit)} je testovací rámec, pomocou ktorého je možné definovať a vykonávať testovacie scenáre. Scenáre popisujú logickú štruktúru akcií a zároveň definujú ich výkonný kód. Príkladom akcie v scenári je príprava testovacieho prostredia, ktorá sa skladá z nasledujúcich akcií: skopírovanie potrebných súborov, kompilácia testovacích artefaktov, spustenie testovacieho rámca, vyhodnotenie jeho výstupu a jeho transformácia do definovaného výstupného formátu. 

\textit{Pracovník (Worker)} je komponent, ktorý spracováva jednotlivé odovzdania a vykonáva ich v izolovanom prostredí iba s potrebnými zdrojmi a oprávneniami. Poskytuje behové prostredie a nízkoúrovňové plánovanie vykonávania testovacích scenárov pomocou KTDK. Je hlavným miestom škálovania výkonu systému a jeho prispôsobenia potrebám jednotlivých predmetov.

Vzájomná nezávislosť komponentov pomocou rozhraní dovoľuje ich jednoduché nahradenie. Napríklad je možné v systéme nahradiť pracovníka vlastnou implementáciou, ktorá portálu na ďalšie spracovanie dodá kompatibilný výstup. Podobne je možné na vykonanie a spracovanie testov použiť vlastný nástroj, a jeho výstup dodať výstup Pracovníkovi vo formáte, ktorý očakáva.
%todo: obr

\section{Portál}

Portál, hlavný komponent celého systému, bol navrhnutý a implementovaný v bakalárskej práci Barbory Kompišovej[cite]. Jeho hlavnou úlohou je vytvoriť logickú štruktúru entít slúžiacich na modelovanie výukového procesu a vzťahov medzi nimi. Druhou úlohou portálu je vystaviť rozhranie, vďaka ktorému je možné systém ovládať a komunikovať s ostatnými komponentmi v systéme. Portál toto rozhranie zabezpečuje a implementuje mechanizmy riadenia prístupu. Na uchovávanie stavu systému v podobe jednotlivých entít a ich atribútov portál využíva relačnú databázu, pretože tieto dáta sú štrukturované a je v nich potrebné efektívne vyhľadávať.

Ako orchestrátor systému je portál primárnym miestom spracovávajúcim hlavný prípad použitia systému -- vytvorenie odovzdania. Pre jedno odovzdanie ide v následnosti o tieto kroky: 
\begin{itemize}
  \item prijať odovzdanie a jeho parametre od študenta
  \item skontrolovať potrebné oprávnenia a obmedzujúce podmienky na počet a frekvenciu odovzdaní
  \item stiahnuť a uložiť súbory potrebné pre spracovanie odovzdania, predovšetkým študentovo riešenie
  \item naplánovať vykonávanie odovzdania na pracovníkovi a odoslať mu nové odovzdanie na spracovanie
  \item prijať výsledok spracovania od pracovníka, uložiť a vyhodnotiť~ho
  \item notifikovať relevantných používateľov --  autora a opravujúceho tohoto odovzdania.
\end{itemize}

Primárnou časťou portálu je server, ktorý vystavuje REST rozhranie, pomocou ktorého je možné s portálom komunikovať. Na rozhranie portálu je možné napojiť rôznych klientov. Hlavnými výhodami REST rozhrania je jeho väzba na \emph{HTTP protokol} a možnosť zabezpečenia pomocou \emph{SSL/TLS protokolu}, umožňujúceho šifrovanie komunikácie. Podrobnejší popis rozhrania portálu a rozpracovanie návrhových a implementačných otázok je možné nájsť v spomínanej bakalárskej práci Bc. Barbory Kompišovej.

\subsection{Klienti portálu}
Vďaka jednotnému rozhraniu prispôsobenému pre automatizovanú prácu bolo pre portál možné vyvinúť niekoľko samostatných klientov. 

\textbf{Frontend} pre systém Kontr 2 bol implementovaný ako súčasť práce Bc. Barbory Kompišovej. Ide o jednostránkovú webovú aplikáciu (\emph{single page application}), ktorá využíva REST rozhranie portálu a ponúka možnosť spravovať entity v systéme, vytvárať odovzdania a prezerať si výsledky. Zamýšľaným rozšírením frontendu je nástroj na prezeranie odovzdaní (\emph{review tool}) sprístupňujúci rozhranie na prezeranie výsledkov a výstupov testovania, jednotlivých súborov odovzdania, pridávanie slovného hodnotenia vo forme komentárov k súborom a prácu s poznámkovými blokmi IS~MU. 

Knižnica \textbf{kontr-api} implementovaná v jazyku Python obaľuje volania REST rozhrania portálu. Slúži ako základ pre písanie nástrojov v jazyku Python, ktoré potrebujú pracovať a komunikovať so systémom Kontr 2. V súčasnosti ju využívajú tri projekty: konzolový nástroj \emph{kontrctl}[link Implementácia Kontrctl], pomocou ktorého je možné pracovať so serverovou častou portálu, \emph{pracovník}, ktorý knižnicu používa na získanie informácii potrebných pre spracovanie odovzdania a \emph{suita testov}[link Implementácia suity testov], ktorá pomocou integračných testov a end-to-end scenárov testuje systém ako celok.

%\subsection{Interné časti portálu}

%Backend portálu v sebe obsahuje integráciu s viacerými externými aj internými nástrojmi. Interné nástroje sú nástroje, ktoré vznikli pre potreby systému, medzi ne patrí napríklad knižnica pre správu úložiska dát na disku - \emph{Úložisko},
%\emph{plánovač}, ktorý plánuje na ktorého pracovníka bude odovzdanie odoslané, \emph{nástroj na spracovanie odovzdania}, ktorý definuje a pravidlá, čo sa má s odovzdaním a jeho výsledkom stať. Súčasťou internej štruktúry portálu je nástroj na \emph{asynchrónne spracovávanie dlhotrvajúcich a náročných} úloh. 
%Jednotlivé časti sú podrobnejšie popísané v separátnych častiach. 


\subsection{Úložisko -- Storage}

Medzi interné nástroje, ktoré v sebe portál obsahuje je modul \emph{Úložisko (Storage)}, ktorého úloha je ukladať, spravovať a spracovávať súbory potrebné pri spracovaní odovzdania. Potenciálne ide o veľké súbory, ktoré je potrebné členiť do stromovej štruktúry. Je preto vhodné tieto súbory ukladať priamo na disk a využiť adresárovú štruktúru. Modul rozlišuje tri základné druhy súborov: 

\textbf{Študentovo riešenie} obsahuje predovšetkým zdrojové kódy, nad ktorými bude vykonávané testovanie. Je potrebné ukladať tieto súbory oddelene pre každé odovzdanie (napr. v samostatných priečinkoch), aby bolo možné vždy k odovzdaniu priradiť súbory, nad ktorými prebehlo testovanie.

\textbf{Testovacie súbory} označujú súbory potrebné na spustenie testov. Patria medzi ne súbory s popisom testovacích scenárov (napr. jednotkové testy), vzorové vstupy, očakávané výstupy či čiastočné implementácie riešenia, umožňujúce izolované testovanie častí odovzdania. Tieto súbory je možné zdieľať pre spracovanie všetkých odovzdaní v projekte, nemá zmysel ich kopírovať ku každému odovzdaniu.

\textbf{Výsledky testov} sú súbory vygenerované počas spracovania odovzdania. Ide predovšetkým o výstupy spustených programov, napríklad záznam kompilácie alebo výstup testovacích rámcov. Je ich potrebné jednoznačne priradiť k odovzdaniu.

Súčasťou úložiska je integrácia s \emph{Gitom}, pomocou ktorého sťahuje odovzdania študentov a testovacie súbory. Pre úsporu miesta na disku modul ponúka možnosť filtrovania ukladaných dát pomocou \emph{glob výrazov} (tzv. \emph{whitelist}) pri sťahovaní odovzdaní a kompresie priečinkov pri ich nevyužívaní.

\subsection{Asynchrónne spracovanie odovzdaní}

Spracovanie odovzdania v portáli je v kontexte webových aplikácii dlhotrvajúca úloha, ktorú nie je možné dokončiť v čase akceptovateľnom pre odpoveď na požiadavku na server v modeli portálom využívaného protokolu HTTP. Vykonanie takejto požiadavky musí prebiehať asynchrónne, aby sa predišlo zbytočnému blokovaniu klientov. Na získanie výsledku spracovania musí klient požiadať samostatným dotazom.

Spracovanie odovzdania portáli sa skladá z nasledujúcich asynchrónnych úloh:
\begin{itemize}
    \item Stiahnutie vypracovania odovzdania študenta
    \item Stiahnutie testovacích súborov
    \item Príprava prostredia pre odovzdanie
    \item Naplánovanie spracovania odovzdania na voľného pracovníka
    \item Spracovanie výsledku testov odovzdania
\end{itemize}

Pre asynchrónne spracovanie úloh sa v portáli využíva \emph{Distribuovaný front úloh (Distributed Task Queue)}, založený na distribuovanom odosielaní správ, ktorý beží ako separátny proces. Väčšina distribuovaných frontov pracuje na princípe \emph{producer-consumer}, kde producentom je proces v ktorom beží REST rozhranie a konzument je proces s distribuovaným frontom. 

Na synchronizáciu a predávanie správ medzi konzumentom a producentom je potrebný tzv. \emph{sprostredkovateľ správ (Message Broker)}. Ide o službu, ktorá zabezpečuje validáciu, verifikáciu, transformáciu a smerovanie správ správ medzi odosielateľom (producentom) a prijímateľom (konzumentom).[cite]

Prínosom distribuovaného frontu úloh je to, že ide o separátny proces, ktorý môže byť nasadený na inom stroji alebo dokonca strojoch, ako je napríklad proces, ktorý spracováva REST dotazy. Druhým dôvodom je, že v štandardnej implementácii jazyka Python - \emph{CPython} nie je možné vykonávať viac ako jedno vlákno súbežne.

Paralelizmus v tomto jazyku je veľmi ovplyvnený tzv. \emph{GIL - Global Interpreter Lock (Globálne uzamknutie interpretra)}\footnote{\url{https://wiki.python.org/moin/GlobalInterpreterLock}} - ide o zámok, ktorý chráni objekty v tomto jazyku a zabraňuje viacerým vláknam vykonávanie python bytekódu súbežne.

\subsection{Plánovače}

Portál obsahuje dva typy plánovačov, ktoré ovládajú proces spracovania odovzdania. Ich úlohou je zabrániť preťažovaniu systému a umožniť využívanie rôznych behových prostredí.

Prvý plánovač slúži na vypočítanie minimálneho časového rozostupu medzi odovzdaniami, tzn. kedy je študentovi povolené vytvoriť a začať spracovávať nové odovzdanie. Konfigurácia plánovača je súčasťou projektu. Jednoduchým príkladom nastavenia plánovača je definovanie fixnej dobu čakania. Ďalšou možnosťou je progresívne zvyšovanie minimálnej doby medzi odovzdaniami na základe celkového počtu odovzdaní študenta.

Druhý plánovač rozhoduje, na ktorom pracovníkovi bude vykonané odovzdanie na základe definovaných kritérií. Do plánovacieho procesu vstupuje vyťaženie a dostupnosť pracovníkov, prítomnosť služieb či nástrojov na jednotlivých pracovníkoch a obmedzujúce podmienky definované správcom systému a zadávajúcim domácej úlohy. Príkladom obmedzení na pracovníka je maximálna miera vyťaženia systémových prostriedkov, preferovaná platforma (operačný systém, jeho verzia) alebo obmedzenie, že daný pracovník môže byť využívaný len určitou skupinou predmetov, projektov alebo študentov. 

Oba typy plánovačov sú súčasťou bakalárskej práce \emph{Mateja Dujavy}, TODO, ktorý sa v svojej práci podrobne venuje návrhu a implementácii oboch plánovačov a ich integrácií so systémom Kontr~2.

\subsection{Nástroj na spracovanie odovzdania -- Submission processing}

Ďalším komponentom portálu je \emph{Nástroj na spracovanie odovzdania (Submission processing)}. Skladá sa z dvoch častí konfigurovateľných zadávajúcim úlohy. Prvou časťou je definícia akcií, ktoré sa majú vykonať pred odoslaním odovzdania na Pracovníka (tzv. \emph{preprocessing}). Medzi tieto úlohy patrí napríklad odoslanie emailu študentovi o vytvorení nového odovzdania.

Druhou fázou je spracovanie výsledkov odoslaných z Pracovníka do portálu \emph{(postprocessing)}. Tu je možné definovať napríklad spracovanie výsledkov z pracovníka, nastavenie bodov a stavu odovzdania, odoslanie emailu autorovi a opravujúcemu či zápis bodov do Poznámkových blokov IS~MU na základe typu odovzdania. 

Spracovanie odovzdania a nastavenie vykonávaných úloh je prispôsobiteľné a modulárne. Každý predmet alebo zadávajúci si môže vybrať zo škály rôznych akcii, ktoré sa majú v jednej z častí vykonať.

Nástroj na spracovanie odovzdania je opäť súčasťou práce \emph{Mateja Dujavy}, TODO, v ktorej sa podrobne venuje návrhu a implementácii.

\subsection{Externé služby}

Externé služby ktoré portál využíva, a s ktorými komunikuje sú Gitlab ako provider identít, LDAP na získanie dodatočných informácii o užívateľovi, SMTP server na odosielanie emailov, klient na komunikáciu s pracovníkom pomocou jeho REST API, API pre poznámkové bloky IS MUNI. 


\subsection{GitLab OpenID connect}

Fakultná inštancia GitLabu je jedným zo systémov, s ktorými Kontr 2 potrebuje komunikovať pre využitie metódy autentizácie používateľov \emph{OpenID Connect}, kde GitLab pre Kontr 2 predstavuje poskytovateľa identít. Vďaka napojeniu na fakultnú LDAP databázu je možné od GitLabu získať údaje o študentoch a učiteľoch na FI MU, čo umožňuje automatické vytváranie dôveryhodných používateľských účtov. Pre administráciu systému, umožnenie prístupu osobám neregistrovaným vo fakultnej databáze účtov a vnútornú organizáciu systému je však stále nutné implementovať vlastnú správu účtov. 

Na získanie dodatočných informácii o užívateľovi je potrebné portál integrovať aj s fakultnou LDAP databázou, ktorá je dostupná len zo siete FI MU. Jednou z dôležitých informácii, ktoré odtiaľto portál získava je UČO (univerzitné číslo osoby) užívateľa. To je uložené v atribúte \emph{description} v LDAP zázname každého užívateľa.

\subsection{Email}
Pre možnosť odosielania emailových správ užívateľom je potrebné portál integrovať s SMTP serverom. Obsah správ a podmienky ich odosielania je možné upraviť na úrovni Kontr~2. Správy systém generuje automaticky na základe definovaných šablón a dodaných parametrov. Adresátov je možné filtrovať na základe ich členstva v kurze, skupine a ich rolí. Podnetom na odoslanie emailovej správy môžu byť napríklad tieto udalosti: vytvorenie užívateľa, zmena užívateľovho hesla, zmena členstva užívateľa v skupine alebo zmena jeho roly v danom predmete.

\subsection{Poznámkové bloky IS MU}
Okrem emailových správ systém používateľom poskytuje spätnú väzbu aj pomocou Poznámkových blokov IS MU. Poznámkové bloky typicky obsahujú bodové, prípadne slovné hodnotenie študentských výsledkov. V prípade Kontru 2 ide o zápis redukovaného výsledku automatických testov. Na základe konfigurácie je možné automaticky zapisovať hodnotenie záväzne, prípadne vyžadovať manuálne potvrdenie výsledkov. Práca s rozhraním Poznámkových blokov IS MU vyžaduje prístupový token, ktorý môžu vyučujúci generovať v IS MU.

Implementácia tejto služby nie je súčasťou tejto práce, no je dôležitá pre reálne využitie systému Kontr 2 v praxi.

\subsection{Knižnica na správu a komunikáciu s Pracovníkom}
Súčasťou portálu je aj knižnica na komunikáciu s pracovníkom a jeho správu. Pomocou nej je možné zistiť stav aktuálne vykonávaného odovzdania, spustiť spracovanie odovzdaného riešenia alebo zistiť jeho aktuálne vyťaženie či definované štítky.

\section{Pracovník - Worker}
Pojem \emph{Pracovník} v systéme Kontr 2 naberá význam na dvoch úrovniach. Ako koncept označuje nástroj, ktorého vstupom je odovzdanie, a popis testovacích scenárov a výstupom je sada definovaných súborov, ktoré sú potrebné pre spracovanie a vyhodnotenie výsledkov testovania. Ako jeden z hlavných komponentov systému predstavuje konkrétnu implementáciu - samostatnú jednotku, ktorej účelom je vykonávať odovzdania na určitom stroji a platforme. 

Koncept Pracovníka je možné implementovať rôznymi spôsobmi, prispôsobeným danému prípadu užitia. Konkrétne implementácie odrážajú potreby predmetov využívajúcich Kontr 2 -- požadované platformy, výhody, služby a zdroje definovaného behového prostredia. Každá implementácia Pracovníka musí spĺňať určité požiadavky, predovšetkým musí vystaviť definované REST rozhranie na umožnenie komunikácie s portálom. 

Pri implementácii a testovacej prevádzke systému bol použitý Pracovník implementovaný pre platformu Linux využívajúci \emph{kontajnerizačnú technológiu}. Využitie kontajnerov v Pracovníkovi umožňuje lepšiu izoláciu a riadenie práv spúšťaných testovacích procesov. Táto implementácia je zamýšľaná ako vzor pre ďalšie špecifické riešenia. Pre využitie platformy Windows bude potrebné overiť možnosť využitia spomínanej kontajnerizačnej technológie, prípadne vyhodnotiť dostupné alternatívy.

\subsection{Priebeh spracovania}

Prijatie a spracovanie odovzdania pracovníkom prebieha v troch fázach:

\begin{itemize}
    \item Príprava prostredia, počas ktorej sú získané všetky potrebné dáta a informácie potrebné pre spracovanie odovzdania
    \item Spustenie testovacích scenárov nad odovzdaním a vygenerovanie výsledkov
    \item Spracovanie výsledkov do očakávanej výstupnej podoby a ich odoslanie do portálu
\end{itemize}

Portál odošle pracovníkovi správu o vytvorení nového odovzdania, ktoré je potrebné spracovať. Pracovník overí, či správa pochádza od jemu známej inštancie portálu a zodpovedá jeho možnostiam.  V prípade, že toto overenie zlyhá, požiadavku zamietne. Zo správnej požiadavky extrahuje základné informácie o odovzdaní -- TODO. Následne pracovník od portálu vyžiada súbory obsahujúce riešenie študenta a súbory potrebné na spustenie testovacích scenárov. Získané dáta sú uložené a pripravené na spracovanie. 

Priebeh ďalšieho spracovania je závislý na konkrétnej implementácii pracovníka. Je pritom potrebné zabezpečiť, aby spracovávané súbory a programy nekompromitovali systém pracovníka (nespôsobili jeho pád alebo poškodenie, nesprístupnili citlivé dáta neoprávneným používateľom, nemanipulovali s priebehom vyhodnotenia). 

Po vykonaní testovacích scenárov Pracovník odošle ich výsledky portálu na spracovanie. Výsledky musia spĺňať formát definovaný v portále (\emph{postproces konfigurácia nástroja na spracovanie odovzdania} pre projekt), aby ich bolo možné správne interpretovať a vyhodnotiť. Pre tento účel portál vystavuje v rozhraní špeciálny koncový bod. Odoslaním výsledku spracovania portálu končí spracovanie odovzdania v Pracovníkovi.

\subsection{Návrh Pracovníka s využitím LXC (Linuxových kontajnerov)}

Na demonštračné účely v rámci testovacieho nasadenia Kontru 2 bolo potrebné detailne rozpracovať a implementovať koncept Pracovníka. Dodaná implementácia má podobnú štruktúru ako portál: vystavuje REST rozhranie v časti nazvanej \emph{načúvač (listener)}, na spracovanie dlhotrvajúcich úloh využíva distribuovaný front (\emph{task worker}) a na predávanie správ medzi \emph{listenerom} a \emph{workerom} používa \emph{messsage broker}. Dôvody a výhody využitia týchto princípov sú popísané v časti \emph{Portál - Asynchrónne spracovávanie náročnejších úloh}. 

Na spracovanie jednotlivých odovzdaní dodaný Pracovník využíva \emph{kontajnerizačnú technológiu} vďaka ktorej je možné spúšťať testovacie scenáre v bezpečnejšom a odtienenom prostredí. \emph{Kontajnerizačná technológia}\footnote{\url{https://en.wikipedia.org/wiki/LXC}} je založená na metóde virtualizácie na úrovni operačného systému, ktorá umožňuje beh viacerých izolovaných linuxových systémov na jednom zdieľanom jadre. Jednou z najznámejších kontajnerových platforiem je produkt \emph{Docker}, ktorý implementácia využíva. Základnými jednotkami v platforme Docker je tzv. \emph{obraz (image)}, na základe ktorého je možné spúšťať mnoho \emph{kontajnerov} -- inštancií daného obrazu. Kontajnery izolujú spúšťané služby od hostiteľského systému a zaručujú tak ľahkú prenositeľnosť medzi rôznymi behovými prostrediami (servermi).[https://www.docker.com/resources/what-container] Všetky odovzdania sú vykonávané oddelene a je ich možné oddeliť od určitých zdrojov fyzického stroja, napríklad siete, pomocou ktorej by mohol sprístupniť citlivé informácie. Rovnako v prípade chyby alebo spustenia nevhodných alebo nebezpečných kusov kódu dôjde len k poškodeniu alebo kompromitovaniu (ľahko nahraditeľného) kontajnera, nie celého systému. Ďalšou výhodou je možnosť prispôsobenia testovacieho prostredia: do obrazu je možné vložiť konkrétne verzie potrebných nástrojov (prekladač, valgrind apod.) bez ohľadu na hosťovský systém.

Základom kontajnerov používaných na testovanie odovzdaní v Pracovníkovi sú obrazy obsahujúce všetky potrebné nástroje. Inštrukcie potrebné na jeho zostavenie sú súčasťou definície testovacích scenárov. Pracovník si testovacie obrazy rôznych úloh rôznych predmetov uchováva v \emph{lokálnom registre obrazov} dovtedy, kým nedôjde k zmene testovacích súborov. Vďaka tomu je proces testovania rýchlejší -- obrazy nie je potrebné zostavovať pre každé odovzdanie zvlášť. Obrazy sú pripravené pred spustením odovzdávania a spravované centrálne.
%Testy spúšťané nad odovzdaním sa vykonávajú v \emph{kontajneri} vytvorenom z \emph{obrazu (image)}, ktorý je zostavený z testovacích súborov. Inštrukcie potrebné na jeho zostavenie sú súčasťou definície testovacích scenárov a spravujú ich vlastníci týchto scenárov. Obrazy sú uchovávané v \emph{lokálnom registre obrazov} dovtedy, kým nedôjde k zmene testovacích súborov. Vďaka tomu je proces testovania rýchlejší, obrazy nie je potrebné zostavovať pre každé odovzdanie zvlášť.

Spracovanie každého odovzdania je spúšťané v samostatnom kontajneri, ktorý z bezpečnostných dôvodov nemá prístup k sieti. Študentovo vypracovanie je do kontejneru vložené pomocou \emph{perzistentného zväzku (persistent volume)}\footnote{https://docs.docker.com/storage/volumes/}, ktoré kontajner smie len čítať \emph{(read-only)}, vďaka čomu nie je možné odovzdanie počas testov modifikovať. Do kontajneru je podobne vložený aj priečinok, do ktorého spracovanie zapíše výsledky testovania. Tento priečinok je po skončení spracovania zabalený a odoslaný portálu.

\subsection{Rozhranie}

Implementácia pracovníka je voľná a samotné spracovanie odovzdania je závislé na potrebách a obmedzeniach daného predmetu alebo úlohy. Každá implementácia pracovníka ale musí vedieť korektne odpovedať na nasledujúce požiadavky, ktoré sú nevyhnutné pre správny chod portálu:

\begin{itemize}
    \item Registrácia pracovníka do portálu
    \item Požiadavka na aktuálny stav pracovníka
    \item Požiadavka na začatie spracovania odovzdania
    \item Požiadavka ukončenie spracovania odovzdania
    \item Požiadavka na aktuálny stav odovzdania
\end{itemize}

\textbf{Registrácia pracovníka do portálu} je nevyhnutná na ustanovenie zabezpečeného spojenia medzi portálom a pracovníkom. Bližší popis sa nachádza v časti [link]

\textbf{Požiadavka na aktuálny stav} informuje portál o aktuálnom vyťažení pracovníka, potrebné pre plánovač portálu. Odpoveď na tento dotaz musí obsahovať informácie o maximálnom počte paralelných spracovaní odovzdaní, ktoré je pracovník schopný spracovať a aktuálny počet spracovávaných odovzdaní. Odpoveď môže obsahovať dodatočné informácie, napríklad vyťaženie prostriedkov stroja \emph{(load)}.

\textbf{Požiadavka na spracovanie odovzdania} obsahuje identifikátor odovzdania, informáciu o projekte, kurze, autorovi odovzdania a dodatočné parametre, ktoré sú potrebné pre beh testov, napríklad parametre pre testovací rámec \emph{KTDK}. Požiadavka je odoslaná portálom po tom, čo je odovzdanie pripravené, tzn. všetky potrebné súbory boli stiahnuté a uplynula nastavená minimálna doba čakania.

\textbf{Požiadavka na aktuálny stav odovzdania} informuje portál o aktuálnom stave spracovania odovzdania s cieľom zistiť prípadné chyby pri spracovaní. Odpoveď by okrem stavu mala obsahovať aj dodatočné informácie, ktoré môžu pomôcť pri hľadaní a oprave chyby.

\emph{Požiadavka na ukončenie spracovávania odovzdania} je potrebná, ak došlo k chybe spracovania a je ho potrebné násilne ukončiť.

\section{Komunikácia medzi portálom a pracovníkom}

Komunikácia medzi portálom a pracovníkom prebieha pomocou REST rozhraní na strane pracovníka a portálu. 

\subsection{Vzájomná autentizácia}

Rozhranie portálu aj Pracovníka je zabezpečené pomocou autentizačného tokenu. 

Registrácia novej inštancie Pracovníka začína vytvorením entity Worker s parametrami \emph{URL pracovníka}, \emph {meno pracovníka} v portáli a nastavením jeho tajomstva (\emph{secret}). Po štarte Pracovníka sa pomocou tohoto tajomstva a svojho mena Pracovník autentizuje voči portálu na známej URL, čím získa prístupový token. Následne portálu pošle svoj (nový) token, ktorý portál uloží a pripája ku všetkým nasledujúcim dotazom na Pracovníka. Tento token slúži na autentizáciu portálu voči Pracovníkovi. Neprítomnosť alebo nerozpoznanie tohoto tokenu v požiadavke znamená jej zamietnutie Pracovníkom. Po úspešnej registrácii je pracovník pripravený spracovávať odovzdania.

Súčasťou registrácie pracovníka je aj zaregistrovanie \emph{štítkov (feature tags)} v portále, ktoré následne využíva plánovač portálu pre rozdeľovanie odovzdaní medzi rôznych pracovníkov. Štítky informujú o možnostiach a dostupných funkciách daného pracovníka, napríklad aký operačný systém je na pracovníkovi nainštalovaný či akú kontajnerizačnú technológiu daný pracovník podporuje. 

\subsection{Spracovanie odovzdania}
Portál pri výbere vhodného pracovníka na spracovanie nového odovzdania zohľadňuje aktuálny stav pracovníka, ktorý získa pomocou požiadavky na stav. O samotný výber sa stará plánovač, popísaný v časti [link]. Vybranému pracovníkovi sa odosiela požiadavka na spracovanie odovzdania. Po jej skontrolovaní a prijatí Pracovník od portálu vyžiada potrebné súbory. Po skončení spracovania odovzdania Pracovník nahrá riešenie do Úložiska portálu a aktualizuje stav a výsledok odovzdania v portáli. Ak výsledky nedorazia v definovanom čase, portál od Pracovníka zisťuje stav odovzdania. V prípade, že je detekovaná chyba, portál odošle požiadavku na zastavenie vykonávania a pokúsi sa spustiť spracovanie odovzdania znova. 

\section{Testovací rámec KTDK - Kontr test development kit}

\emph{KTDK -- Kontr test development kit} je testovací rámec slúžiaci na popis scenárov, pomocou ktorých je možné testovať a vyhodnotiť odovzdania študentov.

Medzi hlavné úlohy rámca patrí definovanie logickej štruktúry testovacích scenárov, ich vykonanie a následné spracovanie výsledkov. Rámec je samostatný komponent a používa sa ako knižnica, ktorá je voľne dostupná[link]. Testy definované pomocou rámca \emph{KTDK} sú Python skripty, ktoré sú majú väzbu na konkrétnu verziu rámca, vďaka čomu je zabezpečená spätná kompatibilita. Nástroj je nezávislý od ostatných súčastí systému Kontr 2, vďaka čomu je napríklad možné využívať lokálnu inštaláciu rámca na správne otestovanie funkčnosti testov a dodaného riešenia. Spúšťanie testovacích scenárov prebieha spustením skriptu s ich definíciou v pripravenom prostredí. %skriptu využívajúceho kód rámca

Pre definíciu testovacích scenárov bolo potrebné navrhnúť štruktúru a model vykonávania testov, ktorý bude ľahko rozšíriteľný a modifikovateľný. Rozhodnutie implementovať vlastný testovací rámec vyplynulo zo špecifických požiadaviek jednotlivých predmetov, predovšetkým ich rôznych postupov testovania. V niektorých predmetoch sa využívajú testy definované v existujúcom testovacom rámci pre daný jazyk (\emph{JUnit, Catch2, pytest}), iné využívajú porovnávanie výstupov aplikácie s očakávanými, pripravenými výstupmi. Ďalej bolo potrebné umožniť kontrolu riešení pomocou externých nástrojov, napr. \emph{Valgrind, Checkstyle, Clang-tidy, Clang-format, ...}.

Na rozdiel od štandardných testovacích nástrojov KTDK oddeľuje definíciu testovacích scenárov od výkonného kódu testov aj testovaného kódu. \emph{Testované súbory} obsahujú zdrojové kódy odovzdané študentom a \emph{testovacie súbory} sú súbory obsahujúce výkonný kód testov, spúšťaný pomocou KTDK. K testovacím súborom je možné zaradiť aj rôzne podporné časti potrebné na testovanie študentovho odovzdania -- pripravené vstupy, čiastočné implementácie apod.

Testovanie pomocou KTDK je možné na konceptuálnej úrovni rozdeliť do niekoľkých fáz:
\begin{itemize}
    \item \emph{Príprava prostredia}: skombinovanie dodaných testovacích a testovaných súborov.
    \item \emph{Kompilácia}: preloženie dodaných súborov do binárnej podoby.
    \item \emph{Spustenie testov nad binárnymi súbormi}: spustenie jednotlivých testov nad výstupom kompilácie
    \item \emph{Spracovanie výsledkov testovania} -- vyhodnotenie výsledkov a výstupov spracovania nástrojmi a priradenie výsledku príp. bodov pre jednotlivé testy
    \item \emph{Vytvorenie výstupu} -- celkový výstup, ktorý je možné spracovať v portáli a ohodnotiť pomocou neho študentovo odovzdanie.
\end{itemize}

Rôzne technológie a jazyky ale vyžadujú rozdielny priebeh testovania (napr. pre interpretované jazyky nie je potrebná kompilácia), preto je uvedený zoznam skôr orientačný. Scenáre sú v KTDK modulárne, ich výsledná podoba preto môže byť pre potreby každého predmetu a úlohy iná. 

\subsection{Štruktúra priečinkov}

Rámec na vstupe očakáva cesty k štyrom priečinkom:
\begin{itemize}
    \item \emph{Priečinok s vypracovaním (testované súbory)} obsahujúci pripravené odovzdanie študenta, ktoré bude testované.
    \item \emph{Priečinok s testovacím súbormi} obsahujúci testovacie scenáre a súbory potrebné na testovanie.
    \item \emph{Priečinok s výsledkami}, do ktorého budú uložené výsledky testovania.
    \item \emph{Pracovný priečinok (workspace)}, do ktorého skopírujú súbory na základe definovaných pravidiel a v ktorom sa bude vykonávať samotné spustenie testov. Pracovný priečinok je po skončení testov zahodený, pretože môže obsahovať výstupy, ktoré nie sú potrebné (napríklad vygenerované binárne súbory).
\end{itemize}

\subsection{Štruktúra testovacích scenárov}
KTDK definuje dva hlavné štrukturálne komponenty: \emph{test} a \emph{úlohu (task)}. Test je definovaný svojím \emph{menom, popisom, bodovým ohodnotením a štítkami (\emph{tags})} a tvorí "obálku" pre určitú časť testovacieho scenára. Testy je možné do seba zanorovať a vytvoriť tak stromovú štruktúru, ktorá logicky člení scenár na lepšie spravovateľné časti a zároveň zoskupuje príbuzné či previazané testy. 

Na test je možné naviazať \emph{úlohy (task)} obsahujúce výkonný kód, ktoré sa v rámci testu majú vykonať. Rámec dodáva škálu základných akcií (napr. presúvanie súborov, kompilácia testov, spracovanie výstupu testovacích nástrojov) a umožňuje definíciu vlastných. Na test sa tiež viaže bodové hodnotenie a celkový výsledok, ktoré sú spočítané po skončení vykonávania testov. Podobne ako testy je možné zanorovať do seba aj úlohy a modelovať tak závislosti medzi nimi.

Každý test obsahuje päť zoznamov úloh, vykonávaných sekvenčne:
\begin{itemize}
    \item Úlohy, ktoré sú vykonané pred testom samotným \emph{(before all)}.
    \item Úlohy, ktoré sú viazané na test \emph{(test's tasks)}
    \item Úlohy, ktoré sú vykonané pred každým potomkom testu \emph{(before each)} 
    \item Úlohy, ktoré sú vykonané po každom potomkovi testu \emph{(after each)}
    \item Úlohy, ktoré sú vykonané po teste samotnom \emph{(after all)}.
\end{itemize}

Existujú tri hlavné kategórie úloh:
\begin{itemize}
    \item \emph{Vykonávacie}, ktoré vykonávajú samotné akcie a spracovávajú výsledky
    \item \emph{Kontrolované (checked)} slúžiace na testovanie podmienok a explicitné rozhodnutie, či test zlyhal alebo prešiel.
    \item \emph{Kontrolované vyžadované (required)} sa správajú rovnako ako kontrolované, ale v prípade zlyhania kontroly dôjde k ukončeniu aktuálne vykonávaného testu a všetkých jeho potomkov.
\end{itemize}


Pre úlohu je možné definovať meno, popis, informatívne štítky a koeficient redukovania počtu bodov za test. \emph{Redukčný koeficient} slúži sa zníženie počtu získaných bodov v prípade, že úloha zlyhala a je \emph{kontrolovaná}. Východzia hodnota je nastavená na 0: v prípade zlyhania jednej úlohy sa predpokladá zlyhanie celého testu a výsledný priradený počet bodov za neúspešný test je nula. Pre testovanie výsledku nástrojom \emph{valgrind} je ale vhodné mať možnosť prideliť percentuálnu časť celkového počtu bodov, napr. s koeficientom 0.7 prideliť zlyhanej valgrind úlohe 70\% plného počtu bodov.

\subsection{Testovacie scenáre}

Testovanie scenáre je potrebné definovať za pomoci \emph{KTDK} a dodaných entít. Testovací rámec je dodávaný ako knižnica jazyka \emph{Python} a preto sa aj scenáre definujú pomocou neho. Vďaka tomu je možné testovací rámec ľahko rozšíriť o potrebnú funkcionalitu alebo upraviť podľa vlastných predstáv. 

Spustenie spracovania testovacích scenárov je rozdelené do troch fáz:
\begin{itemize}
    \item \emph{Načítanie testovacieho scenára}, pri ktorom dôjde k spracovaniu scenára a vybudovaniu stromu závislostí (testov a priradených úloh). Načítanie a budovanie stromu je zabezpečené pomocou konceptov a štruktúr (objektová hierarchia, kolekcie) v jazyku Python.
    \item \emph{Spustenie testovacieho scenára}, pri ktorom dôjde k vykonaniu definovaných úloh v strome a uloženia výsledkov pre dané testy a úlohy.
    \item \emph{Spracovanie výsledkov}, počas ktorého sú spracované a vyhodnotené čiastkové výsledky do jednotného výsledku a výstupu celého testovania.
\end{itemize}

\subsection{Spustenie testovacieho scenára}

Spustenie testovacieho scenára je vykonávané pomocou jednotky nazvanej \emph{spúšťač (runner)}, ktorý je definovaný pre každý \emph{test} a \emph{úlohu}. Spúšťač v sebe definuje spôsob, akým je do bezstavového testu alebo úlohy vložený \emph{kontext (context)} a akým spôsobom a v akom poradí sú spúšťané úlohy a potomkovia testov. 

\ssubsection{Kontext}

\emph{Kontext} je entita reprezentujúca stav, ktorý je postupne predávaný medzi úlohami a testami. Slúži ako jediné možné úložisko \emph{premenných} a konfigurácie, ktoré je potrebné medzi testami a úlohami zdieľať. Jednotlivé časti kontextu sa postupne kopírujú po jednotlivých vetvách stromu zhora nadol. Príkladom využitia kontextu je úloha na kompiláciu, ktorá do kontextu uloží cesty k vytvoreným súborom a nasledujúca úloha spustí testy nad práve týmito súbormi. 

Kontext nie je dostupný pri definícii testov, ale až vo fáze vykonávania testovacieho scenára, pretože do testov a úloh je vkladaný až spúšťačom.

Kontext má tri zložky:
\begin{itemize}
    \item \emph{Globálny}, ktorý je definovaný globálnou konfiguráciou, ktorá je predaná pri spustení celého scenára, jej obsahom sú napríklad cesty k jednotlivým priečinkom, globálne časové limity alebo prednastavené prepínače pre jednotlivé nástroje. 
    \item \emph{Testový}, ktorý je viazaný na jeden test a je zdieľaný všetkými jeho potomkami a úlohami. Do testového kontextu môžu zapisovať len úlohy priamo naviazané na daný test. Pre každého potomka je tento kontext prístupný len na čítanie a úlohy potomkov k nemu prístup nemajú.
    \item \emph{Kontext úlohy} je viazaný len na aktuálnu úlohu, ktorá do neho môže zapisovať a všetky jej podúlohy, ktoré ho môžu čítať.
\end{itemize}

Pre zjednodušenie práce sú všetky tri zložky pri čítaní zlúčené do jednej s nasledujúcimi prioritami: najskôr sa prehľadáva kontext úlohy, následne kontext testu a ako posledný sa prehľadáva globálny kontext. Pri zápise premennej do kontextu je potrebné určiť, do ktorej jeho zložky sa má zapisovať. 

\subsection{Výber testu pre spracovanie}

Jednou z úloh spúšťača je vybrať na základe definovaných kritérií testy, ktoré v danom behu majú byť spustené. Hlavným rozhodovacím kritériom je vyhodnotenie \emph{štítkov testov (tags)}, jednoslovných označení pomocou ktorých je možné testy filtrovať.

Metóda štítkov je založená na vyhodnocovaní \emph{logických výrazov} podľa štítkov prítomných na danom teste. Výraz ako obsahuje mená štítkov a na jeho vyhodnotenie sa využíva jazyk Python. Príkladom výrazu môže byť: \texttt{naostro and not štýly}, na základe ktorého sa vykonajú len tie testy, ktoré sú označené štítkom \emph{naostro} a zároveň nie sú označené štítkom \empty{štýly}. 

Pre vyhodnocovanie výrazov platia nasledujúce pravidlá:
\begin{itemize}
    \item Ak je výraz prázdny, vykonajú sa všetky testy bez obmedzení.
    \item Ak je výraz len jedno slovo, vykonajú sa všetky testy označené týmto slovom, ostatné sú preskočené.
    \item Ak je výraz negácia (\texttt{not <štítok>}), vykonajú sa všetky testy, ktoré nie sú označené týmto štítkom.
    \item Výraz môže byť zložený pomocou logických spojok: \texttt{and} a \textt{or} v obvyklom logickom význame.
    \item Výraz môže obsahovať zátvorky, vďaka ktorým je možné explicitne definovať prioritu vyhodnotenia. 
\end{itemize}

Vzhľadom na stromovú štruktúru testov je potrebné poskytnúť metódy propagácie štítkov:
\begin{enumerate}
    \item Potomkovia obsahujú všetky štítky definované priamo na ich rodičoch (propagácia smerom nadol)
    \item Rodičia obsahujú všetky štítky svojich potomkov (propagácia smerom nahor). Tieto štítky sa nešíria naspäť nadol.
\end{enumerate}

\ssubsection{Možné výsledky testov a úloh}

Výsledky testov a úloh môžeme rozdeliť na \emph{aktuálny výsledok}, ktorý nie je závislý na výsledkoch svojich potomkov a na \emph{efektívny výsledok}, ktorý zohľadňuje aj výsledky potomkov. V prípade, že jeden z potomkov zlyhal, je efektívny výsledok zlyhanie.

Rozlišujeme päť možných stavov pre výsledok:
\begin{itemize}
    \item Žiaden výsledok (\emph{none}) -- test alebo úloha ešte neprebehli.
    \item Úspešný výsledok (\emph{passed}) -- test alebo úloha uspeli.
    \item Preskočený výsledok (\emph{skipped}) -- test bol preskočený a s ním všetky jeho úlohy.
    \item Zlyhaný výsledok (\emph{failed}) -- test alebo kontrola neprešli.
    \item Chyba v teste (\emph{error}) -- test alebo úloha skončili s chybou, jedná sa s najväčšou pravdepodobnosťou o chybný test, chybu v testovacom rámci alebo chybu prostredia
\end{itemize}

\ssubsection{Proces spracovania testu}

Pri spracovaní testu dochádza najskôr k vytvoreniu jeho spúšťača, súčasťou ktorého je vytvorenie kontextu pre daný test. Následne je podľa štítkov testu vyhodnotený dodaný logický výraz. V prípade, že test zadanú podmienku nespĺňa, je jeho výsledok je nastavený na stav \emph{skipped} a pokračuje sa ďalším testom. V opačnom prípade sa spustia \emph{before all} úlohy tohoto testu, následne všetky \emph{before each} úlohy z rodičovského testu. Po nich nasledujú úlohy testu samotného. Ak všetky úlohy prebehnú v poriadku a nedôjde k ukončeniu vykonávania testu, rovnakým spôsobom sú vyhodnotené všetky dcérske testy. Po skončení spracovania potomkov sa spracovávajú \emph{after each} úlohy rodiča a \emph{after all} úlohy testu.

Pri spracovaní každej úlohy dôjde k vytvoreniu \emph{spúšťača úlohy}, ktorý taktiež prechádza strom úloh, ktoré postupne spúšťa a priraďuje im výsledky. Súčasťou spracovania behu úlohy je kontrola správnosti jej vykonávania a vhodné reagovanie na prípadné chyby.

\subsection{Spracovanie výsledkov}

Fáza spracovania výsledkov nasleduje skončení behu testovacích scenárov. Pri spracovaní sa prechádza vybudovaný strom testov a úloh s pridelenými výsledkami, na základe ktorých je vypočítané výsledné bodové hodnoteniu a extrahované informácii o úspešných a neúspešných testoch.

Výstup fázy spracovania obsahuje: finálny výsledok, počet získaných bodov zaokrúhlený na štyri desatinné miesta, zoznam zlyhaných testov a úloh a zoznam všetkých definovaných testov s výsledkami.

Výstup je uložený do priečinka s výsledkami, spolu s výstupmi ostatných nástrojov, logom behu testov a zoznamom súborov vygenerovaných počas behu. Tento priečinok je neskôr predaný na spracovanie pracovníkovi, ktorý jeho obsah odosiela portálu.

\section{Spracovanie nového odovzdania}

Nové odovzdanie môže byť vytvorené študentom alebo učiteľom dotazom na rozhranie portálu. Pri vytvorení nového odovzdania dochádza ku kontrole oprávnení užívateľa a obmedzení kladených na zamedzenie zneužívania systému alebo prekročeniu definovaných limitov. V prípade nesplnenia vyžadovaných kritérií je nové odovzdanie zamietnuté. Kontrola obmedzení prebieha v prvom plánovači portálu, ktorý zohľadňuje definované pravidlá pre danú úlohu (napríklad študent smie odovzdať vypracovanie len za určitý časový interval).

V prípade, že odovzdanie je povolené, uložia sa všetky potrebné informácie o odovzdaní a dáta potrebné k jeho spracovaniu a vyhodnoteniu. Potrebné informácie sú autor odovzdania, predmet a úloha pre ktoré bolo odovzdanie vytvorené, zdroj súborov, nad ktorými bude vykonané testovanie a dodatočné parametre potrebné pre spracovanie. Pre odovzdanie je nastavený časový interval, počas ktorého je možné odovzdanie zrušiť.

Po uplynutí, je spracovanie presunuté do fázy prípravy, v ktorej dôjde k stiahnutiu potrebných súborov a ich uloženie na \emph{úložisko}. Úložisko na stiahnuté súbory aplikuje \emph{filtre} na odstránenie nepotrebných priečinkov a súborov a skomprimuje súbory do archívu.

Ak prípravná fáza skončí úspešne, nasleduje plánovanie, prebiehajúce v druhom plánovači portálu, pri ktorej dochádza k výberu najvhodnejšieho \emph{pracovníka} pre spracovanie odovzdania. V prípade, že žiaden pracovník nie je dostupný, odovzdanie je odložené a jeho spracovaniu dôjde neskôr.

Po úspešnom výbere pracovníka nasleduje testovanie, pri ktorom je notifikovaný vybraný pracovník, o novom odovzdaní s potrebnými informáciami. Pracovník si po prijatí notifikácie stiahne súbory prináležiace danému odovzdaniu - študentovo vypracovanie a súbory s popisom testovacích scenárov. Súbory s popisom testovacích scenárov sú následne spustené v oddelenom prostredí s čo najmenšími oprávneniami aby došlo k minimalizácii možnosti zasahovať do behu systému a jeho možnej kompromitácii.

Pracovník po skončení testovacích scenárov spracuje výsledky a odošle výsledky portálu.

Portál výsledky príjme a spracuje. Výsledky sa spracujú v nástroji na spracovanie odovzdaní, kde sa vykonajú sa definované akcie, napríklad notifikácia všetkých zainteresovaných užívateľov - autora odovzdania (študenta) a opravujúceho študentovho vypracovania (učiteľa). Výsledky sú portálom uložené v úložisku a pomocou API sprístupnené k nahliadnutiu. Súčasťou výsledkov sú výstupy vygenerované behom testov, napríklad výstup prekladača alebo nástrojov na spracovanie zdrojového kódu, výstupy testovacích rámcov a čokoľvek ďalšie, čo môže pomôcť pri hodnotení študentovho vypracovania.

Tieto výstupy spoločne so zdrojovými kódmi odovzdania sú dostupné k nahliadnutiu vo frontende portálu pomocou nástroja na \emph{prezeranie a hodnotenie odovzdaní (review tool)}, pomocou ktorého je možné slovne hodnotiť odovzdania študentov a zapísať im body do poznámkových blokov IS MU. Študenti si následne môžu nájsť hodnotenie priamo pri svojom vypracovaní a môžu ho na základe neho prepracovať. 

\chapter{Implementácia komponentov systému}

Táto kapitola popisuje implementačné detaily systému a jednotlivých komponentov. Hlavnými spracovávanými komponentmi sú \emph{pracovník} a \emph{testovací rámec KTDK}. Kapitola tiež približuje potrebné zmeny v existujúcej implementácii portálu potrebné na integráciu s pracovníkom a ostatnými službami.

Implementácia systému neodráža celý návrh z dôvodu jeho rozsiahlosti a komplexnosti. Niektoré chýbajúce časti budú implementované ako samostatné bakalárske alebo diplomové práce, poprípade ako dobrovoľnícka činnosť jednotlivcov. Pre účely testovacej prevádzky boli niektoré potrebné časti nahradené zjednodušenou implementáciou alebo \emph{stubom}, ktoré slúžia len ako prototypy a bude potrebné ich neskôr nahradiť plnou implementáciou.


\section{Implementácia Portálu}

Návrh a prvotná implementácia Portálu je popísaný v práci Barbory Kompišovej, ktorá sa venuje hlavne problému autentizácie, vzťahom medzi entitami systému, ich správe a konkrétnemu návrhu rozhrania. Implementácia využíva jazyk Python vo verzii 3.6. 

\subsection{Štruktúra portálu}

Implementácia aplikácie ako celku sa skladá z REST API rozhrania implementovanou pomocou mikrorámca \emph{Flask} a jeho rozšírení, výhodou Flasku je jeho jednoduchosť a ľahká rozšíriteľnosť, ktoré boli hlavnými faktormi pri jeho výbere.

Dáta systému môžeme rozdeliť na na 2 typy, dáta popisujúce entity systému a súbory (vypracovanie odovzdania, testovacie súbory). 
Entity sú uložené v relačnej databáze, s ktorou portál komunikuje pomocou \emph{ORM nástroja - SQLAlchemy}, ktorý umožňuje odtieniť implementačné detaily jednotlivých databázových systémov a samotné dotazy je možné zapísať pomocou konštruktov jazyka Python.

Súbory sú uložené na disku, pre vhodné oddelenie implementačných detailov bola zvolená úroveň abstrakcie vo forme separátnej knižnice \emph{storage -- uložisko}, pomocou ktorej dochádza ku komunikácii medzi portálom a zápisom na disk. Uložisko zabezpečuje získanie dát, ich spracovanie a následné uloženie.

\subsection{Zmeny oproti pôvodnej implementácii}

Zmeny pôvodnej implementácie Portálu sa dotkli predovšetkým asynchrónneho spracovania odovzdaní, ktoré bolo v pôvodnej verzii implementované veľmi jednoducho a umožňovalo len uloženie odovzdania do Storage, už nie jeho ďalšie spracovanie. Ďalej bolo Portál potrebné integrovať s fakultnou LDAP databázou, implementovať autentizáciu pomocou \emph{tajomstva (secret)} pre integráciu s Pracovníkom, pozmeniť rozhranie a uľahčiť konfiguráciu a nasadenie Portálu.

\ssubsection{Asynchrónne spracovanie odovzdania}
Pre testovaciu prevádzku systému Kontr 2 bolo potrebné dokončiť všetky akcie potrebné na spracovanie odovzdania po jeho prijatí: uloženie do Storage, získanie testovacích súborov a následné naplánovanie a odoslanie odovzdania Pracovníkovi. Ďalej bolo ako asynchrónnu úlohu potrebné implementovať spracovanie výsledku odovzdania, ktoré sa spúšťa po prijatí výsledku od Pracovníka. Implementácia plánovača ani nástroja na spracovanie odovzdania nie je súčasťou tejto práce, preto sú obe časti dodané v zjednodušenej verzii --  plánovač používa fixný interval počas ktorého je možné odovzdanie zrušiť a vyberá náhodného pracovníka, spracovanie odovzdania nie je konfigurovateľné.

Pre asynchrónne spracovávanie jednotlivých úloh bolo potrebné pridať podporu pre integráciu s  distribuovaným frontom a message brokera. 

Ako \emph{message broker} bol použitý \emph{Redis (Remote Dictionary Server)}, distribuované dátové úložisko typu kľúč-hodnota, uchovávané v pamäti. Podporuje viacero dátových typov (reťazce, čísla, množiny, asociatívne polia, polia a pod.). Jednotlivé asynchrónne úlohy ukladá ako kľúče, hodnoty sú dodatočné informácie o úlohe, napríklad jej parametre. Redis bude neskôr využitý aj v plánovači a to na uchovávanie dodatočných informácií o jednotlivých pracovníkoch.

Asynchrónny front je nástroj, ktorý z Redis-u vezme úlohu a spracuje ju v separátnom procese. V portáli bol využitý nástroj \emph{Celery}, založený na distribuovanom predávaní správ a následnom spracovaní úloh. Jednou z výhod nástroja, je možnosť pozdržať vykonávanie úlohy, čo zjednoduší plánovanie, napríklad je možné nastaviť pozdržanie o 5 min (tzv. \emph{cancellation period}).
Celery pozostáva z 3 hlavných častí. 

Prvou z nich je \emph{klient}, ktorý slúži ako rozhranie pre volanie asynchrónnych úloh. Volania sú vykonávané priamo z aplikačného web servera, ktorý poskytuje REST API rozhranie.

Druhou, asynchrónny pracovník pre celery \emph{(celery worker)} - nepliesť s pracovníkom ako súčasťou systému. Ide o samostatný proces (kolekciu procesov), ktorý vykonáva úlohy asynchrónne bez toho, aby priamo ovplyvňoval aplikačný web server. Samotné úlohy sú implementované taktiež v jazyku Python a majú prístup k celému kontextu aplikácie a zdieľajú kódovú základňu, tzn. priamy prístup k všetkým zdrojom a entitám v systéme, databáze a ostatným službám a komponentom.

Treťou je už spomínaný \emph{message broker}, ktorý zabezpečuje komunikáciu vo forme správ medzi \emph{asynchrónnym pracovníkom} a \emph{klientom v hlavnej webovej aplikácii}.

Celery okrem spracovávania asynchrónnych úloh poskytuje možnosť vykonávania periodických úloh, napríklad každých 10 min. Vďaka tomu je možné periodicky vykonávať kontrolu \emph{chýb odovzdania}, \emph{čistenie systému} a pod. 



Ďalšou zmenou bola integrácia LDAP knižnice pre získanie uča užívateľa z fakultného LDAP serveru, rozšírenie je dostupné len pri nastavení url pre LDAP server, v prípade, že url nie je nastavená, rozšírenie sa neaplikuje a je preskočené. LDAP fakulty informatiky funguje len v rámci jej siete, čo mierne sťažovalo samotnú implementáciu.

Pre jednoduchšie načítavanie konfigurácie a zjednotenie s ostatnými nástrojmi sa použila knižnica \emph{python-dotenv}, pomocou ktorej je možné prepísať premenné prostredia použitím súboru \texttt{.env}. Táto zmena následne uľahčila nasadenie celého projektu.

Medzi menšie zmeny, ktoré bolo potrebné spraviť bolo nahradenie knižnice \emph{flask-restful}, knižnicou \emph{flask-restplus}, ktorá podporuje generovanie \emph{swagger} dokumentácie pre REST API. 

implementácia Secretov

\subsection{Administračný CLI Nástroj}

Portál môže administrátor ovládať priamo pomocou jednoduchého rozšírenia, \emph{Flask CLI}\footnote{\url{http://flask.pocoo.org/docs/1.0/cli/}}, ktoré je súčasťou \emph{rámca Flask}. CLI nástroj v sebe využíva knižnicu \emph{click}, ktorá uľahčuje písanie konzolových nástrojov. 

CLI nástroj má prístup k celému kontextu portálu a jeho úloha je jednoduchá manuálna sprava a spúšťanie administračných skriptov. Utilitu \emph{Flask CLI}, portál používa aj na vygenerovanie alebo aplikovaní databázových migrácii, pomocou ktorých je možné za behu meniť schému databázy. 

\section{Implementácia Pracovníka}

Pracovník bol implementovaný podobným spôsobom ako portál, použitým jazykom bol Python vo verzii 3.6. Rozhranie pracovníka aj metódy autentizácie sú jednoduchšie, podstatná časť je samotné spracovanie odovzdania.

Pracovník vystavuje REST API pomocou mikrorámca \emph{Flask} a jeho rozšírení. 
Autentizácia príchodzích požiadaviek pre pracovníka je zaručená pomocou pevne definovaného \emph{tokenu}, ktorý musí byť súčasťou každého dotazu na pracovníka v autorizačnej hlavičke (\texttt{Authorization: Bearer <token>}). Toto zabezpečenie je možné rozšíriť o klientskú autentizáciu pomocou verejného \emph{SSL certifikátu}\footnote{\url{https://tools.ietf.org/html/rfc5246}}, pri ktorej dôjde k overeniu serveru aj klienta. 

Pracovník na spracovanie dlhotrvajúcich úloh, rovnako ako portál, používa nástroj \emph{celery}\footnote{vid sekcia \emph{Implementácia portálu} a sekcia \emph{Asynchrónne spracovávanie náročnejších úloh} v kapitole Návrh} a \emph{Redis} ako \emph{message broker}. 

\emph{Redis} slúži aj na uchovávanie stavu celého pracovníka, ktorý po spustení je vykonávaný v súbežných procesoch (replikách). Rest API je možné naškálovať na niekoľko podprocesov, rovnako ako \emph{celery worker} spúšťa viacero podprocesov, súbežné spracovávanie úloh. Dáta v pracovníkovi sa rýchlo menia a nie je potrebné ich dlhodobo uchovávať, preto redis ako databáza postačuje a nie je potrebné pridávať ďalšiu relačnú databázu.

\subsection{Kontajnerizačná technológia -- Docker}

Ako kontanjerizačná technológia bol použitý \emph{Docker}. \emph{Docker} je nástroj, pomocou ktorého je možné bežať aplikácie bezpečne izolované v \emph{kontajneri}, zabalené so všetkými závislosťami a knižnicami. \emph{Kontajner} je práve jedna inštancia tejto aplikácie, ktorá je vytvorená z \emph{obrazu (docker image)}. \emph{Obraz} môže byť zdieľaný viacerými kontajnermi\footnote{Analógia je podobná ako medzi programom a procesom, kde obraz je program a proces je kontajner.}. Pre vytvorenie obrazu je potrebný súbor s inštrukciami pre jeho \emph{zostavenie (build)}, súbor sa volá \testtt{Dockerfile}.

Pracovník zostavuje \emph{obrazy} z aktuálnej verzie testovacích súborov automaticky, nutnou súčasťou testovacích súborov je \texttt{Dockerfile}, popisujúci inštrukcie, ktoré sa majú vykonať.

Pre jazyk Python existuje oficiálna knižnica \emph{docker-py}\footnote{\url{https://docker-py.readthedocs.io/en/stable/}}, pomocou ktorej bola podpora pre \emph{docker} do projektu pridaná.


\subsection{Spracovanie odovzdania}

Pracovník po prijatí požiadavky na spracovanie nového odovzdania, extrahuje všetky potrebné informácie a ukladá ich do \emph{redis-u}. Následne vytvára asynchrónnu úlohu v ktorej sa celé spracovanie bude vykonávať.

Asynchrónna úloha ako prvé skontroluje, či pracovník v sebe obsahuje aktuálnu verziu \emph{testovacích súborov}, ktorú je možné zistiť pomocou \emph{hash-u (odtlačku)}\footnote{Štandardne sa jedná o \emph{hash git commitu}}, ktorý je súčasťou požiadavku pre spracovanie odovzdania. Odtlačok je priradený portálom testovacím súborom a je uložený v databáze. Pracovník má uložený separátny zoznam aktuálnych odtlačkov pre \emph{projekty}, v prípade, že sa odtlačok nezhoduje alebo pre daný projekt doposiaľ neexistuje záznam, dôjde k stiahnutiu testovacích súborov a zostavenie \emph{obrazu}, z ktorého sú vytvárané inštancie v podobe kontajnerov v ktorých sa odohráva samotné testovanie. Odtlačok v databáze je súčasne aktualizovaný na najnovšiu verziu.

Po ukončení prípravy testovacích súborov pracovník stiahne študentovo odovzdanie, to je extrahované a uložené do \emph{unikátneho adresára} pre odovzdanie, spolu s ním je vytvorený aj priečinok v ktorom sa budú nachádzať výsledky testovania. 

Následne dôjde k vytvoreniu nového kontajneru, do ktorého sú oba priečinky \emph{pripojené \emph{(mount)}}. Študentovo odovzdanie len s oprávneniami pre čítanie, súbory s výsledkami aj s oprávnením pre zápis. Kontajner je vytvorený bez sieťového rozhrania aby sa zabránilo sieťovej komunikácii a tým sa zvýšila bezpečnosť.

Kontajner je spustení s čo najnižšími oprávneniami a s  právami užívateľa, pod ktorým beží pracovník\footnote{Štandardne pokiaľ nie je povedané inak tak kontajner je spustený pod právami užívateľa \emph{root}.}, vďaka čomu dochádza k zvýšeniu bezpečnosti a všetky vytvorené súbory uložené do priečinka s výsledkami majú správne oprávnenia a je ich možné ďalej spracovávať pracovníkom.

Po dokončení testovacieho procesu pracovník skomprimuje priečinok s výsledkami do jedného \emph{zip} archívu. Odošle výsledky portálu a následne vyčistí prostredie, zmaže vytvorené priečinky a súbory, odstráni docker kontajner a odstráni odovzdanie zo zoznamu aktuálne spracovávaných odovzdaní odovzdaní.

Pracovník je ľahko rozšíriteľný pre natívne vykonávanie odovzdaní, tzn. bez použitia kontajnerizačnej technológie docker, alebo pre možnosť nahradiť docker inou kontajnerizačnou technológiou napríklad \emph{rkt}\footnote{\url{https://coreos.com/rkt/} -- nástroj od firmy CoreOS} alebo \emph{Windows Containers}\footnote{\url{https://docs.microsoft.com/en-us/virtualization/windowscontainers} -- nástroj od firmy Microsoft pre OS Windows}.

\subsection{Administračný CLI Nástroj}

Pracovník rovnako ako portál poskytuje jednoduché rozšírenie pre \emph{Flask CLI}\footnote{\url{http://flask.pocoo.org/docs/1.0/cli/}} obsahujúce administračné príkazy, pomocou ktorých je možné vykonávať jednoduché operácie nad pracovníkom, napríklad zistiť jeho stav, zaregistrovať ho do portálu, alebo manuálne vykonať odovzdanie. CLI nástroj má prístup k celému kontextu pracovníka a jeho úloha je jednoduchá manuálna správa.


\section{Implementácia testovacieho rámca KTDK}

Testovací rámec KTDK je univerzálnym testovacím rámcom, implementovaným v jazyku Python 3.6. Súčasťou rámca je aj \emph{CLI} nástroj slúžiaci na vykonávanie testovacích scenárov a získanie dodatočných informácií o štruktúre scenárov, implementovaný rovnako pomocou knižnice \emph{click}.

\subsection{Konfigurácia}

Konfigurácia testovacieho rámca obsahuje statické informácie, ktoré sú potrebné pre beh rámca. Medzi konfiguračné parametre patria cesty k požadovaným adresárom,
východzie parametre pre jednotlivé aplikácie a programy (prekladač, valgrind), nastavenie behu testov (časové limity, vývojársky mód). Všetky parametre dostupné je možné aj s popisom nájsť v dokumentácii nástroja \emph{ktdk}\footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2/kontr-documentation/blob/master/ktdk/configuration.adoc}}.

Jednotlivé parametre potrebné pre beh testov je možné nastaviť pomocou príkazového riadka, premenných prostredia alebo manuálnym prepisom za využitia konfiguračného súboru. Východzie hodnoty sa nachádzajú v \emph{YAML} súbore: \emph{ktdk/resources/config/defaults.yml}. Tento súbor má najnižšiu hodnotu a ostatné parametre prepisujú východzie hodnoty. 

Konfigurácia po načítaní a spustení vykonávania testovacích scenárov je prístupná pre jednotlive \emph{úlohy a testy} pomocou objektu \emph{kontext}.

\subsection{Spracovnávanie štítkov (tagov)}

Každý test môže obsahovať množinu štítkov, pomocou ktorých je možné test označiť.
Na základe týchto štítkov je možné vybrať, ktoré testy majú byť spustené.

Formát výrazu popisujúci, ktoré testy na základe štítkov majú byť vykonávané, bol jeden z problémov, druhým problémom bolo ako tento formát vyhodnotiť. Pôvodná implementácia spracovávala štítky jednoduchším spôsobom, výraz obsahoval zoznam štítkov oddelených znakom medzera a v prípade, že meno štítku začínalo znakom výkričník, uvažovala sa jeho negácia\footnote{Všetky testy obsahujúce tento štítok budú vynechané}. Príklad: \texttt{"naostro !stylecheck"}, znamenal, spusti všetky testy označené štítkom \emph{naostro}, ale vynechaj všetky, ktoré obsahujú \emph{stylecheck}. Samotná implementácia si najskôr rozdelila jednotlivé štítky do množín a kontrolovala prieniky medzi množinami. 

Po preskúmaní možností tejto implementácie bola ale zvolený variant pomocou ktorého je možné spracovávať logické výrazy. Napríklad: \texttt{"naostro and not stylecheck"}, ktorá explicitne hovorí že musia byť splnené obe podmienky. Zaujímavá možnosť je aj rozšírenie o výrazy so zátvorkami, pomocou ktorých je možné písať komplexné výrazy ako napríklad: \texttt{"(naostro or nanecisto) and not bonus"}. 

Druhý variant môže byť vyhodnotený za pomoci interpretru jazyka Python, za pomoci funkcie \texttt{eval}. Vzhľadom na to, že funkcia \texttt{eval} je potenciálne nebezpečná, hlavne ak je spustená nad vstupom ktorý zadal užívateľ. Našťastie, je možné funkcii definovať, ku ktorým objektom, modulom a premenným má prístup a následne do nej vložiť kontext, nad ktorým môže operovať. 

Implementácia interpretra štítkov odstraňuje všetky dostupné globálne a lokálne objekty a nahradzuje ich špeciálne upraveným kontextom, v ktorom každý štítok je premená, ktorá nadobúda hodnotu \emph{True} alebo \emph{False}, na základe toho, či je štítok definovaný na danom teste. 

\subsection{Implementácia entít}

Dve základné entity slúžiace na popis testovacích scenárov sú \emph{Test} a \emph{Task (úloha)}. Oba sú objekty, ktorým je možné pri popise scenára nastaviť pomocou konštruktora parametre potrebné k ich identifikácii. 

\texttt{Task} (úloha) je objekt, ktorému je potrebné definovať metódu \texttt{run}, ktorá definuje, čo sa má vykonať v momente spustenia úlohy. Ku tzv. kontextu danej úlohy je možné pristupovať len \emph{za behu}\footnote{Nie je možné pristúpiť ku kontextu napríklad v konštruktore alebo pri inicializácii jeho stavu. Kontext je dostupný až po volaní metódy \texttt{invoke}, ktorá interne volá metódu \texttt{run}}.

Spustenie testov a úloh je zabezpečené pomocou \emph{Runner}-u, ktorý definuje v akom poradí a akým spôsobom dôjde k spusteniu jednotlivých úloh a testov. Každý test a úloha môže využívať iný spúšťač, ktorý je možné definovať ako jeden z parametrov úlohy alebo testu. Existuje východzia implementácia spúšťača, ktorý vykonáva jednotlivé úlohy v sekvencii za sebou. V budúcnosti by bolo možné implementovať paralelnú variantu, ktorá by mohla časť testov vykonávať paralelne.

Inštancia spúšťača pre danú úlohu alebo test sa vytvára vtedy, keď prídu je potrebné ich spracovať. Spúšťač testu skontroluje podmienky pre beh testu \emph{( napríklad štítky)} a v prípade, že test nemá byť spustený, nastaví výsledok testu na preskočený. Inak pokračuje spustením úloh a dcérskych testov v definovanom poradí.

V prípade úloh spúšťač volá nad úlohou metódu \texttt{invoke}, ktorá sa vykonáva v \emph{try-catch} bloku a odchytávajú sa výnimky - \texttt{RequireFailedError} a \texttt{Exception}. Prvá z nich nastáva, ak zlyhal \emph{require assert}, ktorý hovorí, že ak je podmienka ním testovaná vyhodnotená na \texttt{False}, má dôjsť k ukončeniu vykonávania testu a výsledok testu má byť nastavený na \texttt{FAIL}.

V prípade, že je zachytená všeobecná výnimka, došlo k neočakávanej chybe, ktorá nastať nemala a jedná sa chybný stav testu samotného. Výsledok testu je preto nastavený ako \texttt{ERROR}, čo značí, že test fatálne zlyhal a v ostrej prevádzke by chyba testov nastať nemala. 

\subsection{Písanie testovacích scenárov}

Testovacie scenáre pre automatizované testovanie je možné pridať priamo do repozirára s testovacími súbormi do priečinka \emph{kontr\_tests}. V tejto zložke dôjde k načítaniu súboru \testtt{instructions.py}, ak nie je ktdk nastavené inak.

Celý priečinok \emph{kontr\_tests} je pridaný na štandardné cesty modulov jazyka \emph{python}\footnote{\url{https://docs.python.org/3/reference/import.html}}, čo zabezpečí, že všetky moduly a balíky definované v tomto priečinku sú sprístupnené spúšťaciemu skriptu.

Príklady testovacích scenárov a ako ich písať je možné nájsť v \emph{dokumentácii}\footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2/kontr-documentation/blob/master/ktdk/writing_scenarios_in_ktdk.adoc}} a \emph{repozitároch s príkladmi}\footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2/examples/}}. 

\section{Implementácia ostatných častí}

Kontr portál predstavuje hlavnú entitu, ktorá vystavuje REST API, pomocou ktorého je možné systém ovládať. Súčasťou práce bola implementácia knižnice \emph{kontr-api} taktiež v jazyku Python, ktorá zaobaľuje REST-ové volania do sady metód a funkcii a odpovede do objektov. Knižnica rieši autentizáciu voči portálu, vykonávanie a spracovávanie požiadaviek pre portál, ktoré realizuje knižnicou \emph{requests}. 
Knižnicu využívajú hlavne \emph{pracovník}, \emph{suita testov} a \emph{kontrctl}. 

\emph{Kontrctl} je \emph{CLI} nástroj využívajúci knižnicu \emph{click} na prijatie a spracovanie príkazov a \emph{tabulate} na štrukturované zobrazovanie tabuliek. Nástroj implementuje primárne CRUD operácie nad entitami v systéme za pomoci \emph{kontr-api} a je možné pomocou neho spravovať viacero inštancii kontru, ktoré sú rozlíšené pomocou tzv. \emph{remote}. 

Pre každú z nich je možné definovať vlastnú sadu parametrov a premenných ako napríklad užívateľ pod ktorým sa majú príkazy vykonávať, prístupové informácie \emph{(access\_token, refresh\_token, secret)}, \emph{url}, na ktorej je dostupné Portal API a východzie premenné ako napríklad východzí kurz (predmet), nad ktorým sa majú operácie vykonávať.

Informácie a konfigurácia pre jednotlivé \emph{remote} sa nachádza v domovskom priečinku užívateľa v zložke, závislej na platforme\footnote{Pre linux je to: \texttt{~/.config/kontrctl/}, MS Windows: \emph{\%appdata\%/kontrctl}}, to je docielené pomocou funkcie dodávanej v knižnici \emph{click}\footnote{\url{http://click.palletsprojects.com/en/7.x/api/#click.get_app_dir}}.

Viac o použití a nastavení \emph{kontrctl} je možné sa dozvedieť v dokumentácií\footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2/kontr-documentation/tree/master/kontrctl}}.

\chapter{Nasadenie a popis prostredia}

Kapitola nasadenia pojednáva o možnostiach nasadenia systému ako celku vo vývojovom, testovacom a produkčnom prostredí, súčasťou kapitoly je aj popis generovania výstupov vo forme knižníc a \emph{kontajnerov}, pomocou ktorých je možné systém dodať.

Systém sa skladá z viacerých repozitárov, ktoré je možné nájsť na fakultnom Gitlabe\footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2}}. Repozitáre obsahujúce výkonný kód majú nastavené \emph{CI/CD pipeline}, pre automatickú kontrolu zdrojového kódu a spustenie testov nad každým \emph{merge requestom} do \emph{master branch}. Vďaka čomu je možné čiastočne kontrolovať, či jednotlivé zmeny nespôsobia závady v už existujúcich častiach komponenty.

\section{Nasadenie vývojovej verzie}

Nasadenie vývojovej verzie je možné dvoma základnými spôsobmi, prvou z nich je \emph{natívne nasadenie}, pre ktoré je potrebné stiahnuť si aktuálne verzie repozitárov jednotlivých projektov a nastaviť ich pomocou inštrukcii definovaných v dokumentácii. Táto metóda vyžaduje mať všetky závislosti nainštalované a správne nastavené na stroji, na ktorom systém bude nasadený.

Druhou metódou je nasadenie pomocou kontajnerizačného nástroja \emph{docker}. Pre každú komponentu systému je definovaný tzv. \emph{Dockerfile}, popisujúci inštrukcie potrebné k zostaveniu \emph{obrazu \emph{image}}, ktorý je možné následne spustiť vo forme kontajneru, ktorý beží izolovane so všetkými svojimi závislosťami.

Už zostavené \emph{obrazy} je možné nájsť na docker registri \emph{(dockerhub)}\footnote{\url{https://hub.docker.com/u/kontr2}}. Obrazy je možné z registra stiahnuť pomocou príkazu \texttt{docker pull <meno-obrazu>}\footnote{Príklad: \texttt{docker pull kontr2/portal}, stiahne a uloží na lokálny stroj zostavenú verziu portálu}.

Systém pozostáva zo siedmich kontajnerov \emph{(portal-gunicorn, portal-celery, worker-gunicorn, worker-celery, redis, postgres, frontend)}, medzi ktorými je potrebné vytvoriť prepojenia, spustiť ich so správnymi oprávneniami a pridať do nich \emph{persistent volumes} na správne destinácie. Pre zjednodušenie nastavenia a prepojenia častí bol vytvorený \emph{docker-compose súbor \texttt{(docker-compose.yml)}}\footnote{\url{https://docs.docker.com/compose/compose-file/}}, ktorý je vstupom pre nástroj slúžiaci na správu viacerých kontajnerov a zdrojov na jednom užívatelskom stroji -- \emph{docker-compose}\footnote{\url{https://docs.docker.com/compose/reference/}}. Nátroj umožnuje nasadiť celý systém pomocou troch príkazov\footnote{\texttt{docker-compose down \&\& dokcer-compose build \&\& docker-compose up}}, vďaka čomu zjednodušuje nasadenie systému pri vývoji, robí systém dostupnejším pre nových vývojárov a zjednodušuje nasadenie testovacej inštancie. Skript aj s inštrukciami je možné nájsť v pomocnom repozirári \emph{docker} \footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2/docker/tree/master/platform}}, ktorý obsahuje nástroje a skripty pre prácu s nástrojom \emph{docker}.

Proces nasadenia vývojovej verzie pozostáva z troch fáz. Prvou z nich je získanie potrebných repozitárov, z ktorých je systém zostavený \emph{(portál, pracovník, frontend a docker)}. Všetky repozitáre je potrebné stiahnuť pomocou verzovacieho nástroja \emph{git}. Druhou fázou je zostavenie obrazov z aktuálnych verzii repozitárov. Tretou je inicializácia dát a testovacieho prostredia, ktorá zahŕňa vytvorenie databázových tabuliek a vloženie testovacích dát a entít do systému. Jedným z krokov je aj inicializácia a zaregistrovanie pracovníka do systému, čim je zabezpečené, že systém je po spustení pripravený na spracovávanie testovacích odovzdaní.

Výhodou kontajnerizacie celého systému je možné neskoršie nasadenie do systému pre automatické nasadenie, škáľovanie a manažment kontajnerizovaných aplikácii. Napríklad \emph{docker swarm}\footnote{\url{https://docs.docker.com/engine/swarm/}} alebo \emph{kubernetes}\footnote{\url{https://kubernetes.io}}. Fakulta informatiky v budúcnosti uvažuje o možnosti nasadenia niektorých svojich služieb na Kubernetes cluster.


\section{Nasadenie produkčnej verzie}

Produkčná verzia je aktuálne nasadená v Stratus.FI. \emph{Stratus.FI}\footnote{\url{https://stratus.fi.muni.cz/}} je privátny cloud pre užívateľov z FI postavený na software \emph{OpenNebula}\footnote{\url{http://www.opennebula.org/}}.
Primárnym účelom je poskytnúť užívateľom prostredie na experimentovanie a rýchle vysúšanie alebo aj produkčné použitie softvéru, ktorý z rôznych dôvodov nemôže byť nainštalovaných priamo na serveroch spravovaných CVT FI (napríklad Anxur nebo Aisa)\cite{fi-tech-stratus}.

Produkčné nasadanie pozostáva z dvoch virtuálnych strojov, z ktorých na prvom beží portál backend a frontend a na druhom pracovník. Oba stroje sú postavené na distribúcii CentOS vo verzii 7.5.

Systém využíva \emph{postgres} databázu dodávanú fakultou informatiky

\subsection{Produkčtné nasadenie portálu}

Parametre stroja s nasadeným portálom:
\begin{itemize}
    \item RAM: 4GB
    \item Procesor: 4 virtuálne jadrá
    \item Veľkosť disku: 50GB
\end{itemize}

Stroj, na ktorom je nainštalovaný portál je dostupný z verejnej siete a má pridelenú verejnú IP a doménu \texttt{\url{https://kontr.fi.muni.cz}}, pre ktorú je vygenerovaný a podpísaný certifikát pomocou služby \emph{Let's encrypt}\footnote{\url{https://letsencrypt.org/}}, ktorá je taktiež aj certifikačnou autoritou. Využitie protokolu \emph{https}\cite{RFC2818} postaveného nad TLS\cite{RFC8446} zabezpečuje šifrovanú komunikáciu medzi portálom(serverom) a jednotlivými klientmi(worker, frontend, kontr-api).

Konfigurácia \emph{HTTPS} spojenia, sprístupnenie API portálu a frontendu nástroja Kontr bolo dosiahnuté pomocou NGINX\footnote{\url{https://www.nginx.com/resources/wiki/}} http servera a reverse proxy. Backend portálu je spustený v niekoľkých inštanciách(procesoch) pomocou \emph{Python WSGI HTTP serveru -- Gunicorn}. NGINX je nastavená ako proxy, ktorá slúži ako verejné rozhranie a všetky požiadavky sú posielané cez ňu na backend API. Rovnako NGINX sprístupnuje aj statický obsah (frontend), zložený z \emph{html, typescript, css súborov a obrázkov}.

\emph{Gunicorn} a \emph{Celery} bežia ako separátne služby, obsluhované pomocou \texttt{systemd}. Bolo pre ne nutné napísať vlastné \emph{servisné súbory}\footnote{\url{https://www.freedesktop.org/software/systemd/man/systemd.service.html}}. Komunikáciu pre asynchrónne spracovávanie služieb zabezpečuje služba \emph{Redis}, dostupná len na lokálnej sieti stroja.

\subsection{Produkčné nasadenie pracovníka}

Parametre stroja s nasadeným pracovníkom:
\begin{itemize}
    \item RAM: 4GB
    \item Procesor: 4 virtuálne jadrá
    \item Veľkosť disku: 20GB
\end{itemize}

Stroj, na ktorom je nainštalovaný pracovník sa nachádza na privátnej sieti Stratus.FI a nie je dostupný priamo z internetu. Pracovník a portál spolu komunikujú cez privátnu sieť, pretože pracovník nemôže komunikovať s portálom priamo po verejnej sieti(nastavenie FireWall-u). Naneštastie to spôsobuje problémy s validáciou certifikátu vydaného pre portál, preto bolo potrebné zmeniť v \texttt{/etc/hosts} súbore resolvovanú IP adresu portálu na privátnu IP adresu, z ktorej je portál dostupný na privátnej sieti.

Na pracovníkovi je taktiež nasadený NGINX, pomocou ktorého je zabezpečené API pracovníka pomocou \emph{SSL/TLS self-signed certifikátu}, ktorý bol podpísaný zdieľanou certifikačnou autoritou pre portál a pracovníka. Problém, na ktorý sa narazilo bol ten, že knižnica \emph{requests} má v sebe vložený vlastný zoznam \emph{CA (Certifikačná autorita)}\cite{RFC5280} a ignoruje \emph{systémový trust store}. Našťastie je možné pomocou premennej prostredia prepísať cestu k \emph{zoznamu CA (CA bundle)}.

Rovnako ako pre portál, aj pre pracovníka bolo potrebné vytvoriť servisné súbory pre \emph{systemd} a nainštalovať a spustiť vlastnú inštanciu \emph{Redis-u}.


\subsection{Zabezpečenie pomocou SSL/TLS certifikátov}

Komunikáciu v systéme je potrebné v produkčnom prostredí zabezpečiť, REST API portálu a pracovníka boli zabezpečené pomocou SSL/TLS, vďaka ktorému komunikácia prebieha šifrovane. 

Pomocou SSL certifikátov je možné vyžadovať aj autentizáciu klienta voči serveru.
Pre časť operácii sa pracovník správa ako klient voči portálu a pre druhú časť naopak ako server, je potrebné aby sa overovali obe strany komunikácie. Overenie vyžaduje certifikačnú autoritu, ktorá podpísala certifikát serveru aj klienta\cite{RFC2818}. Klient aj sever musia mať certifikačnú autoritu pridanú medzi \emph{trusted}. Nevýhodou tejto metódy je komplikovaná konfigurácia ako na strane serveru, tak na strane klienta a pre menej skúseného administrátora môže predstavovať netriviálnu komplikáciu.

Súčasné nasadenie využíva len verifikáciu server certifikátu a klientský certifikát sa neoveruje.

\subsection{Automatizácia nasadenia}

V budúcom vývoji je plánované automatizovať proces nasadenia celého systému v podobe inštalátora, implementovaného napríklad v podobe \emph{Ansible playbooks}. \emph{Ansible} je nástroj, ktorý automatizuje inštalovanie systému, konfiguráciu a nasadzovanie aplikácii\cite{ansible}. 

V súčasnosti existuje repozitár s \emph{Ansible playbookmi}\footnote{\url{https://gitlab.fi.muni.cz/grp-kontr2/ansible}} pre automatické nasadenie a aktualizáciu aplikácii bežiacich na produkčných strojoch. Playbook \emph{pull-ne} zmeny z repozitárov v Gitlabe, nainštaluje závislosti, spustí migrácie databázy, vygeneruje novú verziu frontendu a reštartuje \emph{gunicorn a celery služby}.

Pomocou tohoto skriptu je možné nasadzovať zmeny okamžite po tom, čo sú otestované, bez nutnosti zdĺhavo sa prihlasovať na server a manuálne vykonávať všetky príkazy. V budúcom vývoji je plán ako automatizovať celý proces ešte viac - kedy by sa vždy po otestovaní a prebehnutí všetkých potrebných verifikácií spustil tento skript automaticky a každá zmena bola nasadzovaná bez manuálneho zásahu.

\chapter{Testovacia prevádzka}

Testovacia prevádzka prebiehala v obmedzenom režime, vzhľadom na to, že systém stále nie je dokončený. Testovacie prostredie bolo predstavené v predchádzajúcej kapitole v sekcii, produkčné nasadenie. Testovanie bolo umožnené všetkým vyučujúcim predmetu PB161 a vybraným študentom, ktorých sa prihlásilo sedem, testovacia prevádzka prebiehala na úlohe \emph{HW03}\footnote{\url{https://www.fi.muni.cz/pb161/hw03/zadani}}. Pre všetkých zainteresovaných bolo vytvorené interné diskusné fórum v IS MU, v ktorom mohli nahlasovať chyby, pýtať sa na nejasnosti alebo navrhovať rôzne vylepšenia systému.

Študenti odovzdávali svoje riešenia cez frontend UI, v ktorom si následne mohli prezrieť výsledky testovania (počet bodov a jednotlivé testy s informáciou o ich úspechu alebo neúspechu). Obmedzenia testovacej prevádzky boli napríklad, chýbajúca integrácia \emph{review toolu}, plánovača alebo duplikovanie odovzdaní medzi novým a starým systémom Kontr, ktorá prebiehala manuálne. Študenti boli za testovanie a hľadanie chýb odmenení bonusovými bodmi.

\section{Výstup testovania}
Výstupy testovania je možné rozdeliť na chyby a nedostatky nájdené počas testovania a štatistiky využitia systému.

\subsection{Chyby nájdené počas testovania}

Pred samotným študentským testovaním boli odhalené viaceré nedostatky v \emph{logovaní udalostí}, ktoré sa v systéme dejú, hlavným problémom bolo priradenie aktéra, k danej udalosti (kto udalosť vyvolal), preto bolo potrebné pridať túto informáciu do výstupu. Logy boli rozdelené do separátnych súborov, napríklad \emph{autorizačný log}, v ktorom sa zaznamenáva len každé úspešné, ale aj neúspešné prihlásenie.

Študentské testovanie, odhalilo viacero chyb a nedostatkov vo frontende, pre väčšinu z nich bola založená issue v gitlabe a časť z nich sa už podarilo opraviť.
Závažnejšie chyby, ktoré vyplávali na povrch, sa týkali hlavne backendu a testovacieho rámca \emph{KTDK}, medzi ktoré patrilo nekorektné spracovanie odovzdania (výsledky neboli uložené), nesprávne spočítanie bodov a chybné spracovanie asynchrónnych úloh.

Chyby týkajúce sa nesprávneho spracovania odovzdania a nesprávneho počítania bodov by mali byť už opravené. Problémom bol špecifický prípad, kedy test zlyhal na \texttt{SIGSEGV}\footnote{\url{http://man7.org/linux/man-pages/man7/signal.7.html}}, tak \emph{Junit výstup}, ktorý je neskôr spracovávaný, bol nevalidný\footnote{Súbor bol nekompletný, čo bolo spôsobené nedokončením zápisu z dôvodu ukončenia programu}, vzhľadom na to, že \emph{JUnit} výstup je generovaný testovacím rámcom \emph{Catch2}, nie je možné tento problém riešiť inak, ako udeliť za test nula bodov. 



\subsection{Vybrané Štatistiky}

Z testovania úlohy HW03 (Bomberman) v predmete PB161 v semestri jeseň 2018 vzišli nasledujúce štatistiky.
Čas potrebný k spracovaniu odovzdania bol počítaný od momentu vytvorenia odovzdania po uloženie výsledkov do portálu.

\begin{itemize}
    \item Testovacích odovzdaní HW03 bolo 31. 
    \item Čas potrebný pre spracovanie odovzdania, aj s vytvorením testovacieho obrazu\footnote{Pri prvom odovzdaní so zmenenými testovacími súbormi je potrebné znovu zostaviť obraz\texttt{docker build}.}: +- 5 min.
    \item Čas potrebný pre spracovanie odovzdania s vytvoreným testovacím obrazom: +- 2 min.
    \item Dĺžka behu testovacích scenárov v \emph{KTDK}: 85s. (Starý kontr: 68s)
\end{itemize}

\textbf{Využitie miesta na disku v úložisku:}

\begin{itemize}
    \item Celková veľkosť súborov v úložisku bola $53MB$.
    \item Priemerná veľkosť zdrojových súborov jedného odovzdania je $308KB$ a pre skomprimovaný variant $100KB$.
    \item Priemerná veľkosť výsledkov jedného odovzdania je $500KB$ a skomprimovaný variant $66 KB$.
    \item Maximálna veľkosť výsledkov bola $1.4MB$ a skomprimovaný variant $96KB$.
    \item Pre 1000 odovzdaní \emph{(100 študentov po 10 odovzdaní)} je potrebných $(500 KB + 308KB \approx 1MB) * 1000 \approx 1 GB$ miesta, v prípade komprimovanej varianty je to $(66KB + 100KB \approx 200KB) * 1000 \approx 200MB$
\end{itemize}

\chapter{Záver a budúci vývoj systému}
\addcontentsline{toc}{chapter}{Záver}

Úlohou práce bolo vypracovať analýzu a vysokoúrovňový návrh systému opravy domácich úloh Kontr 2 a implementácia podsystému pre spracovanie odovzdaní. 
Dôraz pri návrhu bol kladený na splnenie požadovaných prípadov užitia, zohľadnenie požiadaviek predmetov, ktoré by mali záujem systém používať a prípadne jeho ľahkú rozšíriteľnosť.

Systém ako celok bol rozdelený do nezávislých komponent či, už ako separátne aplikácie alebo moduly(knižnice), ktoré je možné v prípade potreby nahradiť alebo jednoduchšie rozšíriť. Nezávislosť komponent vyžadovala jednoznačne definovať rozhranie a komunikačné kanály, pomocou ktorých komunikujú.

Návrh jednotlivých komponent bol postupne rozpracovaný v tejto práci, ale jednalo sa len o vysokoúrovňový pohlaď, pretože komplexný návrh napríklad portálu bol súčasťou inej práce, v ktorej bol implementovaný základ, do ktorého bol integrovaný podsystém pre spracovanie odovzdaní, ktorý je výstupom tejto práce.
Samotný podsystém nie je kompletný pretože pokročilejšie plánovanie a spracovanie výsledkov úloh, je súčasťou nadväzujúcich prác.

V kapitole venujúcej sa implementácii je rozpracovaná aktuálna implementácia podsystému pre spracovanie odovzdaní, integrácia a zmeny ktoré bolo potrebné v Portály spraviť a pomocné nástroje a knižnice, ktoré bolo potrebné implementovať pre uľahčenie práce so systémom.

Na implementačnú kapitolu naväzuje kapitola predstavujúca možnosti nasadenia, detailnejšie popisuje produkčné prostredie, stroje na ktorých je produkčná verzia nasadená. 

Posledná kapitola popisuje priebeh testovacej prevádzky, nájdené problémy, návrhy na vylepšenie a výstupy v podobe štatistiky využitia disku, spotrebovaného času pre vykonanie úlohy.

Výstupom tejto práce je systém schopný spracovať a vyhodnotiť odovzdanie, preto tvorí základ pre ďalšie rozširovanie a dopĺňanie funkcionality. Celý projekt je verejne dostupný a má otvorený zdrojový kód, preto ktokoľvek kto má záujem, má možnosť prispievať a rozšíriť ho. So systémom sa stretne každý študent, ktorý si prejde základným kurzom nízkoúrovňového programovania, preto je možné týchto ľudí zaujať a dať im možnosť vyskúšať si prispieť do projektu s otvoreným zdrojovým kódom. 
Nástroj by mohol mať úspech minimálne tým, že je implementovaný v moderných technológiách, je vyvíjaný priamo na fakulte a bude sa dotýkať väčšiny študentov.

V súčastnosti na zásadnejšie zmeny systému budú nadväzovať ďalšie práce. Rovnako autor tejto práce plánuje na práci ďalej pracovať a projekt spravovať. V systéme je ešte mnoho chýb, chýba rozsiahlejšia dokumentácia a návody, ktoré by ukázali ako so systémom pracovať a vysvetlili jednotlivé jeho časti.

Systém sa bez ďalších dobrovoľníkov nezaobíde, nejde len o vývoj nových rozšírení, ale aj o testovanie, nasadenie a správu systému, všetka táto \emph{neviditeľná} práca je potrebná pre beh systému ako takého.




\appendix %% Start the appendices.
\chapter{An appendix}
Here you can insert the appendices of your thesis.

\end{document}
